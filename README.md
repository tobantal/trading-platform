# Trading Platform Microservices

> **ĞšÑƒÑ€ÑĞ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚:** OTUS Microservice Architecture  
> **GitHub:** https://github.com/tobantal/trading-platform.git 
>
> **ĞĞ²Ñ‚Ğ¾Ñ€:** ĞĞ½Ñ‚Ğ¾Ğ½ Ğ¢Ğ¾Ğ±Ğ¾Ğ»ĞºĞ¸Ğ½  
> **Ğ”Ğ°Ñ‚Ğ°:** Ğ¯Ğ½Ğ²Ğ°Ñ€ÑŒ 2025  
> **Ğ’Ğ¸Ğ´ĞµĞ¾ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñ‹:** _[ÑÑÑ‹Ğ»ĞºĞ° Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ°]_

ĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ»Ñ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»Ğ¸ Ğ½Ğ° ĞœĞ¾ÑĞºĞ¾Ğ²ÑĞºĞ¾Ğ¹ Ğ±Ğ¸Ñ€Ğ¶Ğµ. Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ° ĞºĞ°Ğº Ğ½Ğ°Ğ±Ğ¾Ñ€ Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² Ñ event-driven Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ¾Ğ¹.

---

## ğŸ— ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

### ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              TRADING PLATFORM                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                   Internet
                                      â”‚
                                      â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚     Ingress      â”‚
                           â”‚  arch.homework   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                       â”‚                       â”‚
            â–¼                       â–¼                       â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Auth Service   â”‚    â”‚ Trading Service â”‚    â”‚ Broker Service  â”‚
   â”‚     :8081       â”‚    â”‚     :8082       â”‚    â”‚     :8083       â”‚
   â”‚                 â”‚    â”‚  (API Gateway)  â”‚    â”‚(Source of Truth)â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                      â”‚                      â”‚
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”              â”‚
            â”‚              â”‚               â”‚              â”‚
            â”‚         REST â”‚          AMQP â”‚              â”‚
            â”‚              â–¼               â–¼              â”‚
            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
            â”‚    â”‚ Auth Service â”‚  â”‚   RabbitMQ   â”‚â—€â”€â”€â”€â”€â”€â”€â”¤
            â”‚    â”‚  (validate)  â”‚  â”‚trading.eventsâ”‚       â”‚
            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
            â”‚                                             â”‚
            â–¼                       â–¼                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    auth_db      â”‚    â”‚   trading_db    â”‚   â”‚   broker_db     â”‚
   â”‚   PostgreSQL    â”‚    â”‚   PostgreSQL    â”‚   â”‚   PostgreSQL    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ

| Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ | ĞĞ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ |
|---------|-------------|
| **Broker = Source of Truth** | Ğ’ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°Ñ…, Ğ¾Ñ€Ğ´ĞµÑ€Ğ°Ñ…, Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸ÑÑ… Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ |
| **Trading = API Gateway** | Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ, ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, idempotency |
| **Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Exchange** | `trading.events` Ğ´Ğ»Ñ Ğ²ÑĞµÑ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (Ğ¾Ğ´Ğ¸Ğ½ routing) |
| **Event-Driven Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´** | ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ñ€Ğ´ĞµÑ€Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· RabbitMQ |
| **REST Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²** | Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ |

---

## ğŸ¯ Roadmap Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HELLOWORLD  â”‚â”€â”€â”€â–¶â”‚    MVP      â”‚â”€â”€â”€â–¶â”‚  EDUCATION  â”‚â”€â”€â”€â–¶â”‚ PRODUCTION  â”‚
â”‚   devops    â”‚    â”‚  monolith   â”‚    â”‚   Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°    â”‚    â”‚   FUTURE    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      âœ…                 âœ…                 âœ…                 ğŸ”œ
      â”‚                  â”‚                  â”‚                  â”‚
      â–¼                  â–¼                  â–¼                  â–¼
 Ğ˜Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°    Ğ“ĞµĞºÑĞ°Ğ³Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ     ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑÑ‹      Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ API
 Docker Compose    Fake Broker        Service Split     Tinkoff gRPC
 FetchContent      PostgreSQL         RabbitMQ          Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸
 Prometheus        JWT Auth           Kubernetes        WebSocket
                   REST API           Prometheus        Security
                                      Grafana           Avro
                                      Simple UI         UI     
```

---

## ğŸ—º C4 Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹

### Level 1: System Context

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SYSTEM CONTEXT                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Trader  â”‚
    â”‚ (User)  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚ HTTPS/REST
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Trading Platform   â”‚
â”‚                     â”‚
â”‚ ĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ° Ğ´Ğ»Ñ       â”‚
â”‚ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹     â”‚
â”‚ Ñ‚Ğ¾Ñ€Ğ³Ğ¾Ğ²Ğ»Ğ¸            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ gRPC/REST (Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞµ)
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tinkoff Invest API  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Moscow Exchange â”‚
â”‚ (External Broker)   â”‚   FIX   â”‚     (MOEX)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Level 2: Container Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TRADING PLATFORM                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Trader  â”‚
                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                   â”‚ HTTPS
                                   â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   Ingress    â”‚
                           â”‚    nginx     â”‚
                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ /auth               â”‚ /trading            â”‚ /broker
            â–¼                     â–¼                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Auth Service   â”‚â—€â”€â”€â”‚ Trading Service â”‚â”€â”€â–¶â”‚ Broker Service  â”‚
   â”‚    C++:8081     â”‚   â”‚    C++:8082     â”‚   â”‚    C++:8083     â”‚
   â”‚                 â”‚   â”‚  (API Gateway)  â”‚   â”‚(Source of Truth)â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                     â”‚
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”              â”‚
            â”‚              â”‚             â”‚              â”‚
            â”‚         HTTP â”‚        AMQP â”‚              â”‚
            â”‚              â–¼             â–¼              â”‚
            â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
            â”‚    â”‚         RabbitMQ             â”‚â—€â”€â”€â”€â”€â”€â”€â”¤
            â”‚    â”‚      trading.events          â”‚       â”‚
            â”‚    â”‚                              â”‚       â”‚
            â”‚    â”‚ order.create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚       â”‚
            â”‚    â”‚ order.cancel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚       â”‚
            â”‚    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ order.filled     â”‚       â”‚
            â”‚    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ order.rejected   â”‚       â”‚
            â”‚    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ portfolio.updatedâ”‚       â”‚
            â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
            â”‚                                           â”‚
            â–¼                     â–¼                     â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    auth_db      â”‚   â”‚   trading_db    â”‚   â”‚   broker_db       â”‚
   â”‚   PostgreSQL    â”‚   â”‚   PostgreSQL    â”‚   â”‚   PostgreSQL      â”‚
   â”‚                 â”‚   â”‚                 â”‚   â”‚                   â”‚
   â”‚ â€¢ users         â”‚   â”‚ â€¢ idempotency_  â”‚   â”‚ â€¢ broker_orders   â”‚
   â”‚ â€¢ accounts      â”‚   â”‚   keys          â”‚   â”‚ â€¢ broker_positionsâ”‚
   â”‚ â€¢ sessions      â”‚   â”‚                 â”‚   â”‚ â€¢ broker_balances â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â€¢ instruments     â”‚
                                               â”‚ â€¢ quotes          â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Level 3: Component Diagram â€” Trading Service

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TRADING SERVICE (API Gateway)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRIMARY ADAPTERS (HTTP Handlers)                                           â”‚
â”‚                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚HealthHandler â”‚  â”‚MarketHandler   â”‚  â”‚PortfolioHndlrâ”‚  â”‚IdempotentHndlrâ”‚   â”‚
â”‚ â”‚ GET /health  â”‚  â”‚GET /instrumentsâ”‚  â”‚GET /portfolioâ”‚  â”‚  (Decorator)  â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚GET /quotes     â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚                  â”‚           â”‚
â”‚                           â”‚                  â”‚                  â–¼           â”‚
â”‚                           â”‚                  â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                           â”‚                  â”‚          â”‚ OrderHandler â”‚    â”‚
â”‚                           â”‚                  â”‚          â”‚ POST/DELETE  â”‚    â”‚
â”‚                           â”‚                  â”‚          â”‚  /orders     â”‚    â”‚
â”‚                           â”‚                  â”‚          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                  â”‚                 â”‚
                            â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  APPLICATION LAYER                                                           â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚MarketService   â”‚  â”‚PortfolioSvc  â”‚  â”‚ OrderService â”‚  â”‚ TradingEvent  â”‚   â”‚
â”‚  â”‚                â”‚  â”‚              â”‚  â”‚              â”‚  â”‚  Handler      â”‚   â”‚
â”‚  â”‚â€¢ getInstrumentsâ”‚  â”‚â€¢ getPortfolioâ”‚  â”‚â€¢ createOrder â”‚  â”‚â€¢ onOrderFilledâ”‚   â”‚
â”‚  â”‚â€¢ getQuotes     â”‚  â”‚â€¢ getPositionsâ”‚  â”‚â€¢ cancelOrder â”‚  â”‚â€¢ onPortfolio  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  Updated      â”‚   â”‚
â”‚         â”‚                   â”‚                 â”‚          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                   â”‚                 â”‚                 â”‚
          â–¼                   â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SECONDARY ADAPTERS                                                         â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚HttpAuthClientâ”‚  â”‚CachedBroker  â”‚  â”‚RabbitMQ      â”‚  â”‚PostgresIdem- â”‚     â”‚
â”‚  â”‚              â”‚  â”‚  Gateway     â”‚  â”‚  Adapter     â”‚  â”‚ potencyRepo  â”‚     â”‚
â”‚  â”‚POST /validateâ”‚  â”‚â€¢ LRU Cache   â”‚  â”‚â€¢ Publisher   â”‚  â”‚â€¢ find(key)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â€¢ HttpBroker  â”‚  â”‚â€¢ Consumer    â”‚  â”‚â€¢ save(key)   â”‚     â”‚
â”‚         â”‚          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚                 â”‚
          â–¼                 â–¼                 â–¼                 â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Auth Serviceâ”‚   â”‚Broker Svc  â”‚   â”‚  RabbitMQ  â”‚   â”‚trading_db  â”‚
   â”‚  :8081     â”‚   â”‚  :8083     â”‚   â”‚            â”‚   â”‚ PostgreSQL â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sequence: Create Order (Idempotent)

```
  Client          IdempotentHandler        trading_db          OrderHandler
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚ POST /orders       â”‚                     â”‚                    â”‚
    â”‚ X-Idempotency-Key: â”‚                     â”‚                    â”‚
    â”‚   "key-123"        â”‚                     â”‚                    â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                    â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚                    â”‚ SELECT FROM         â”‚                    â”‚
    â”‚                    â”‚ idempotency_keys    â”‚                    â”‚
    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚                    â”‚ NOT FOUND           â”‚                    â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚                    â”‚ delegate            â”‚                    â”‚
    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚                    â”‚                     â”‚    201 {order_id}  â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚                    â”‚ INSERT INTO         â”‚                    â”‚
    â”‚                    â”‚ idempotency_keys    â”‚                    â”‚
    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚ 201 {order_id}     â”‚                     â”‚                    â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                    â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚ POST /orders       â”‚                     â”‚                    â”‚
    â”‚ X-Idempotency-Key: â”‚                     â”‚                    â”‚
    â”‚   "key-123" (same) â”‚                     â”‚                    â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                    â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚                    â”‚ SELECT FROM         â”‚                    â”‚
    â”‚                    â”‚ idempotency_keys    â”‚                    â”‚
    â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                    â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚                    â”‚ FOUND {cached}      â”‚                    â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
    â”‚                    â”‚                     â”‚                    â”‚
    â”‚ 201 {same order_id}â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—    â”‚
    â”‚ X-Idempotency-Key- â”‚ â•‘ CACHE HIT â€” handler NOT called    â•‘    â”‚
    â”‚   Used: true       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                    â”‚
```

---

## ğŸ”§ ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑÑ‹

### Auth Service (Ğ¿Ğ¾Ñ€Ñ‚ 8081)

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ, Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°Ğ¼Ğ¸.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AUTH SERVICE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Adapters (Primary)           â”‚  Adapters (Secondary)           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚  â€¢ RegisterHandler            â”‚  â€¢ PostgresUserRepository       â”‚
â”‚  â€¢ LoginHandler               â”‚  â€¢ PostgresAccountRepository    â”‚
â”‚  â€¢ LogoutHandler              â”‚  â€¢ PostgresSessionRepository    â”‚
â”‚  â€¢ ValidateTokenHandler       â”‚  â€¢ FakeJwtProvider              â”‚
â”‚  â€¢ GetAccessTokenHandler      â”‚                                 â”‚
â”‚  â€¢ GetAccountsHandler         â”‚                                 â”‚
â”‚  â€¢ AddAccountHandler          â”‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application                  â”‚  Domain                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚  â”€â”€â”€â”€â”€â”€                         â”‚
â”‚  â€¢ AuthService                â”‚  â€¢ User                         â”‚
â”‚  â€¢ AccountService             â”‚  â€¢ Account (SANDBOX/REAL)       â”‚
â”‚                               â”‚  â€¢ Session                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹:**

| ĞœĞµÑ‚Ğ¾Ğ´ | ĞŸÑƒÑ‚ÑŒ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Auth |
|-------|------|----------|------|
| GET | `/health` | Health check | - |
| POST | `/api/v1/auth/register` | Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ | - |
| POST | `/api/v1/auth/login` | Ğ›Ğ¾Ğ³Ğ¸Ğ½ â†’ session_token | - |
| POST | `/api/v1/auth/logout` | Ğ’Ñ‹Ñ…Ğ¾Ğ´ | Session |
| POST | `/api/v1/auth/validate` | Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ° (internal) | - |
| POST | `/api/v1/auth/access-token` | ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ access_token | Session |
| GET | `/api/v1/accounts` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ¾Ğ² | Session |
| POST | `/api/v1/accounts` | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ | Session |
| DELETE | `/api/v1/accounts/{id}` | Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ | Session |

---

### Trading Service (Ğ¿Ğ¾Ñ€Ñ‚ 8082)

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** API Gateway, Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ, ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ, idempotency, Ğ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       TRADING SERVICE                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Adapters (Primary)           â”‚  Adapters (Secondary)           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚  â€¢ OrderHandler               â”‚  â€¢ HttpAuthClient               â”‚
â”‚  â€¢ PortfolioHandler           â”‚  â€¢ HttpBrokerGateway            â”‚
â”‚  â€¢ MarketHandler              â”‚  â€¢ CachedBrokerGateway          â”‚
â”‚  â€¢ IdempotentHandler          â”‚  â€¢ RabbitMQPublisher            â”‚
â”‚                               â”‚  â€¢ RabbitMQConsumer             â”‚
â”‚                               â”‚  â€¢ PostgresIdempotencyRepo      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application                  â”‚  Domain                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚  â”€â”€â”€â”€â”€â”€                         â”‚
â”‚  â€¢ OrderService               â”‚  â€¢ Order, OrderRequest          â”‚
â”‚  â€¢ MarketService              â”‚  â€¢ Portfolio, Position          â”‚
â”‚  â€¢ PortfolioService           â”‚  â€¢ Quote, Instrument            â”‚
â”‚  â€¢ TradingEventHandler        â”‚  â€¢ Money, IdempotencyRecord     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹:**

| ĞœĞµÑ‚Ğ¾Ğ´ | ĞŸÑƒÑ‚ÑŒ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Auth |
|-------|------|----------|------|
| GET | `/health` | Health check | - |
| GET | `/api/v1/instruments` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² | - |
| GET | `/api/v1/instruments/{figi}` | Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾ FIGI | - |
| GET | `/api/v1/instruments/search?query=` | ĞŸĞ¾Ğ¸ÑĞº | - |
| GET | `/api/v1/quotes?figis=` | ĞšĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ | - |
| POST | `/api/v1/orders` | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ€Ğ´ĞµÑ€ â†’ RabbitMQ | Access |
| GET | `/api/v1/orders` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¾Ñ€Ğ´ĞµÑ€Ğ¾Ğ² | Access |
| GET | `/api/v1/orders/{id}` | ĞÑ€Ğ´ĞµÑ€ Ğ¿Ğ¾ ID | Access |
| DELETE | `/api/v1/orders/{id}` | ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¾Ñ€Ğ´ĞµÑ€ â†’ RabbitMQ | Access |
| GET | `/api/v1/portfolio` | ĞŸĞ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ | Access |

**ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**

| Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ | TTL | Ğ Ğ°Ğ·Ğ¼ĞµÑ€ | ĞĞ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ |
|--------|-----|--------|-------------|
| ĞšĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ | ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ | 1000 | Ğ§Ğ°ÑÑ‚Ğ¾ Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ |
| Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ | Ğ”Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹ | 500 | Ğ ĞµĞ´ĞºĞ¾ Ğ¼ĞµĞ½ÑÑÑ‚ÑÑ |

---

### Broker Service (Ğ¿Ğ¾Ñ€Ñ‚ 8083)

**ĞÑ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ:** Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¾Ñ€Ğ´ĞµÑ€Ğ¾Ğ², ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¾Ğ¼, ÑĞ¸Ğ¼ÑƒĞ»ÑÑ†Ğ¸Ñ Ğ±Ğ¸Ñ€Ğ¶Ğ¸.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       BROKER SERVICE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Adapters (Primary)           â”‚  Adapters (Secondary)           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”‚
â”‚  â€¢ OrdersHandler (GET only)   â”‚  â€¢ FakeBrokerAdapter            â”‚
â”‚  â€¢ PortfolioHandler           â”‚  â€¢ PostgresBrokerOrderRepo      â”‚
â”‚  â€¢ InstrumentsHandler         â”‚  â€¢ PostgresBrokerPositionRepo   â”‚
â”‚  â€¢ QuotesHandler              â”‚  â€¢ PostgresBrokerBalanceRepo    â”‚
â”‚                               â”‚  â€¢ RabbitMQPublisher            â”‚
â”‚                               â”‚  â€¢ RabbitMQConsumer             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application                  â”‚  Domain                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚  â”€â”€â”€â”€â”€â”€                         â”‚
â”‚  â€¢ OrderCommandHandler        â”‚  â€¢ BrokerOrder                  â”‚
â”‚  â€¢ MarketDataPublisher        â”‚  â€¢ BrokerPosition               â”‚
â”‚                               â”‚  â€¢ BrokerBalance                â”‚
â”‚  Broker Simulation            â”‚  â€¢ Instrument, Quote            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€           â”‚                                 â”‚
â”‚  â€¢ OrderProcessor             â”‚  Events                         â”‚
â”‚  â€¢ PriceSimulator             â”‚  â”€â”€â”€â”€â”€â”€                         â”‚
â”‚  â€¢ MarketScenario             â”‚  â€¢ OrderCreatedEvent            â”‚
â”‚                               â”‚  â€¢ OrderFilledEvent             â”‚
â”‚                               â”‚  â€¢ OrderRejectedEvent           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹ (Internal API):**

| ĞœĞµÑ‚Ğ¾Ğ´ | ĞŸÑƒÑ‚ÑŒ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|-------|------|----------|
| GET | `/health` | Health check |
| GET | `/api/v1/orders?account_id=` | ĞÑ€Ğ´ĞµÑ€Ğ° Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° |
| GET | `/api/v1/orders/{id}?account_id=` | ĞÑ€Ğ´ĞµÑ€ Ğ¿Ğ¾ ID |
| GET | `/api/v1/portfolio?account_id=` | ĞŸĞ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ |
| GET | `/api/v1/instruments` | Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² |
| GET | `/api/v1/instruments/{figi}` | Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾ FIGI |
| GET | `/api/v1/quotes?figi=` | ĞšĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° |

**Ğ ĞµĞ¶Ğ¸Ğ¼Ñ‹ ÑĞ¸Ğ¼ÑƒĞ»ÑÑ†Ğ¸Ğ¸ (BROKER_FILL_BEHAVIOR):**

| Ğ ĞµĞ¶Ğ¸Ğ¼ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|-------|----------|
| `IMMEDIATE` | ĞœĞ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ |
| `REALISTIC` | Market ÑÑ€Ğ°Ğ·Ñƒ, Limit Ğ¶Ğ´ÑƒÑ‚ Ñ†ĞµĞ½Ñƒ |
| `PARTIAL` | Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ |
| `DELAYED` | Ğ¡ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ (async) |
| `ALWAYS_REJECT` | Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑÑ‚ÑŒ (Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¾Ğ²) |

---

## ğŸ” ĞÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ

### Ğ”Ğ²ÑƒÑ…ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AUTHENTICATION FLOW                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Client                     Auth Service                Trading Service
    â”‚                             â”‚                            â”‚
    â”‚ 1. POST /auth/register      â”‚                            â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
    â”‚         {user_id}           â”‚                            â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
    â”‚                             â”‚                            â”‚
    â”‚ 2. POST /auth/login         â”‚                            â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
    â”‚      {session_token}        â”‚                            â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
    â”‚                             â”‚                            â”‚
    â”‚ 3. GET /accounts            â”‚                            â”‚
    â”‚    [Session Token]          â”‚                            â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
    â”‚      [{account_id, ...}]    â”‚                            â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
    â”‚                             â”‚                            â”‚
    â”‚ 4. POST /auth/access-token  â”‚                            â”‚
    â”‚    {account_id}             â”‚                            â”‚
    â”‚    [Session Token]          â”‚                            â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                            â”‚
    â”‚      {access_token}         â”‚                            â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                            â”‚
    â”‚                             â”‚                            â”‚
    â”‚ 5. POST /orders             â”‚                            â”‚
    â”‚    [Access Token]           â”‚                            â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                             â”‚   POST /auth/validate      â”‚
    â”‚                             â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                             â”‚   {user_id, account_id}    â”‚
    â”‚                             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚         {order_id}          â”‚                            â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### Ğ¢Ğ¸Ğ¿Ñ‹ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²

| Token | Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | TTL |
|-------|----------|------------|-----|
| `session_token` | user_id | Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Auth Service | 24 Ñ‡Ğ°ÑĞ° |
| `access_token` | user_id + account_id | ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ² Trading Service | 1 Ñ‡Ğ°Ñ |

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²

```bash
# 1. Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
curl -X POST http://arch.homework/auth/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username": "trader1", "email": "trader@example.com", "password": "secret123"}'

# 2. Ğ›Ğ¾Ğ³Ğ¸Ğ½ â†’ session_token
curl -X POST http://arch.homework/auth/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "trader1", "password": "secret123"}'
# Response: {"session_token": "eyJ...", "user_id": "user-xxx"}

# 3. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ access_token
curl -X POST http://arch.homework/auth/api/v1/auth/access-token \
  -H "Authorization: Bearer <session_token>" \
  -H "Content-Type: application/json" \
  -d '{"account_id": "acc-sandbox-001"}'
# Response: {"access_token": "eyJ...", "account_id": "acc-sandbox-001"}

# 4. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ access_token
curl http://arch.homework/trading/api/v1/orders \
  -H "Authorization: Bearer <access_token>"
```

---

## ğŸ“¨ Event-Driven Architecture

### ĞĞ±Ğ·Ğ¾Ñ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EVENT ARCHITECTURE                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Trading Service              RabbitMQ                 Broker Service
       â”‚                          â”‚                           â”‚
       â”‚                          â”‚                           â”‚
       â”‚    order.create â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                           â”‚
       â”‚    order.cancel â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  trading.events â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
       â”‚                          â”‚    (exchange)             â”‚
       â”‚                          â”‚                           â”‚
       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€ order.created â”€â”€â”‚                           â”‚
       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€ order.filled â”€â”€â”€â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚â—€â”€ order.partially_filled â”‚                           â”‚
       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€ order.rejected â”€â”‚                           â”‚
       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€ order.cancelled â”‚                           â”‚
       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€ quote.updated â”€â”€â”‚                           â”‚
       â”‚â—€â”€â”€â”€â”€â”€ portfolio.updated â”€â”‚                           â”‚
```

### ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ¾Ğ´Ğ¸Ğ½ Exchange?

| Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ | ĞŸĞ»ÑÑÑ‹ | ĞœĞ¸Ğ½ÑƒÑÑ‹ |
|---------|-------|--------|
| **Ğ”Ğ²Ğ° exchange** (trading.events + broker.events) | Ğ›Ğ¾Ğ³Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ | Ğ¡Ğ»Ğ¾Ğ¶Ğ½ĞµĞµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ |
| **ĞĞ´Ğ¸Ğ½ exchange** (trading.events) âœ… | ĞŸÑ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ğ°, ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ routing | Ğ’ÑĞµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ |

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¾Ğ´Ğ¸Ğ½ `trading.events` exchange Ñ‚Ğ¸Ğ¿Ğ° `topic`. Routing keys Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑÑÑ‚ Ğ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ.

### Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ

| Ğ¡Ğ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ | Producer | Consumer | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|----------|----------|
| `order.create` | Trading | Broker | ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ½Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ€Ğ´ĞµÑ€Ğ° |
| `order.cancel` | Trading | Broker | ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ½Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½Ñƒ Ğ¾Ñ€Ğ´ĞµÑ€Ğ° |
| `order.created` | Broker | Trading | ĞÑ€Ğ´ĞµÑ€ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ |
| `order.filled` | Broker | Trading | ĞÑ€Ğ´ĞµÑ€ Ğ¿Ğ¾Ğ»Ğ½Ğ¾ÑÑ‚ÑŒÑ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½ |
| `order.partially_filled` | Broker | Trading | Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ |
| `order.rejected` | Broker | Trading | ĞÑ€Ğ´ĞµÑ€ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½Ñ‘Ğ½ |
| `order.cancelled` | Broker | Trading | ĞÑ€Ğ´ĞµÑ€ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‘Ğ½ |
| `quote.updated` | Broker | Trading | ĞšĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° |
| `portfolio.updated` | Broker | Trading | ĞŸĞ¾Ñ€Ñ‚Ñ„ĞµĞ»ÑŒ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»Ñ‘Ğ½ |

### Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹

**order.create:**
```json
{
  "order_id": "ord-a1b2c3d4",
  "account_id": "acc-001",
  "figi": "BBG004730N88",
  "direction": "BUY",
  "type": "MARKET",
  "quantity": 10,
  "price": 265.50,
  "currency": "RUB",
  "timestamp": "2025-01-04T12:00:00Z"
}
```

**order.filled:**
```json
{
  "order_id": "ord-a1b2c3d4",
  "account_id": "acc-001",
  "figi": "BBG004730N88",
  "status": "FILLED",
  "executed_lots": 10,
  "executed_price": 265.75,
  "currency": "RUB",
  "timestamp": 1704369601000
}
```

**quote.updated:**
```json
{
  "figi": "BBG004730N88",
  "bid": 265.50,
  "ask": 265.80,
  "last_price": 265.65,
  "currency": "RUB",
  "timestamp": 1704369600000
}
```

**portfolio.updated:**
```json
{
  "account_id": "acc-001",
  "timestamp": 1704369601000,
  "cash": {"amount": 973500.00, "currency": "RUB"},
  "positions": [
    {"figi": "BBG004730N88", "quantity": 100, "average_price": 265.75}
  ],
  "total_value": {"amount": 1000100.00, "currency": "RUB"}
}
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Market Order

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 SCENARIO: SUCCESSFUL ORDER                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Client              Trading                Broker               DB
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚ POST /orders       â”‚                     â”‚                   â”‚
    â”‚ {figi, qty, BUY}   â”‚                     â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                   â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚ Validate JWT        â”‚                   â”‚
    â”‚                    â”‚ Validate FIGI       â”‚                   â”‚
    â”‚                    â”‚ Check Idempotency   â”‚                   â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚ order.create â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚ 201 {PENDING}      â”‚                     â”‚ Check balance     â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚ Reserve funds     â”‚
    â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚                     â”‚ Execute order     â”‚
    â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚ order.filled â—€â”€â”€â”€â”€â”€â”€â”‚ Update position   â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚ portfolio.updated â—€â”€â”‚ Commit reserved   â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚ GET /orders/{id}   â”‚                     â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                   â”‚
    â”‚                    â”‚ GET /orders â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚ 200 {FILLED}       â”‚                     â”‚                   â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                   â”‚
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: ĞÑ‚ĞºĞ»Ğ¾Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Order (Insufficient Funds)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SCENARIO: REJECTED ORDER (NO FUNDS)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Client              Trading                Broker               DB
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚ POST /orders       â”‚                     â”‚                   â”‚
    â”‚ {figi, qty, BUY}   â”‚                     â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                   â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚ order.create â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚ 201 {PENDING}      â”‚                     â”‚ Check balance     â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚                     â”‚ âŒ Insufficient   â”‚
    â”‚                    â”‚                     â”‚    funds          â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚ order.rejected â—€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                    â”‚ {reason: "..."}     â”‚                   â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚ GET /orders/{id}   â”‚                     â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                   â”‚
    â”‚ 200 {REJECTED}     â”‚                     â”‚                   â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                   â”‚
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SCENARIO: PARTIAL FILL                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Client              Trading                Broker               DB
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚ POST /orders       â”‚                     â”‚                   â”‚
    â”‚ {qty: 100}         â”‚                     â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                   â”‚
    â”‚                    â”‚ order.create â”€â”€â”€â”€â”€â”€â–¶â”‚                   â”‚
    â”‚ 201 {PENDING}      â”‚                     â”‚                   â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                   â”‚
    â”‚                    â”‚                     â”‚ Execute 50/100    â”‚
    â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚ order.partially_    â”‚                   â”‚
    â”‚                    â”‚ filled {50}    â—€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚                     â”‚ (Ğ¿Ğ¾Ğ·Ğ¶Ğµ) 50/100    â”‚
    â”‚                    â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚                    â”‚ order.filled â—€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚
    â”‚                    â”‚                     â”‚                   â”‚
    â”‚ GET /orders/{id}   â”‚                     â”‚                   â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚                   â”‚
    â”‚ 200 {FILLED,       â”‚                     â”‚                   â”‚
    â”‚      qty: 100}     â”‚                     â”‚                   â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                   â”‚
```

---

## ğŸ”„ Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ğµ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ğ¾Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ: Ğ˜Ğ·Ğ±ĞµĞ¶Ğ°Ğ½Ğ¸Ğµ Saga

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ĞŸĞĞ§Ğ•ĞœĞ£ Ğ£ ĞĞĞ¡ ĞĞ•Ğ¢ Ğ ĞĞ¡ĞŸĞ Ğ•Ğ”Ğ•Ğ›ĞĞĞĞ«Ğ¥ Ğ¢Ğ ĞĞĞ—ĞĞšĞ¦Ğ˜Ğ™           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  âŒ ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ° (ÑĞ»Ğ¾Ğ¶Ğ½Ğ°Ñ):           âœ… ĞĞ°Ñˆ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ (Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹):
  
  Trading           Broker             Trading           Broker
     â”‚                 â”‚                  â”‚                 â”‚
     â”‚ INSERT order    â”‚                  â”‚                 â”‚
     â”‚â”€â”€â”€â”€â–¶ trading_db â”‚                  â”‚  (stateless*)   â”‚
     â”‚                 â”‚                  â”‚                 â”‚
     â”‚ order.create â”€â”€â–¶â”‚                  â”‚ order.create â”€â–¶ â”‚
     â”‚                 â”‚                  â”‚                 â”‚
     â”‚ order.filled â—€â”€â”€â”‚                  â”‚ order.filled â—€â”€ â”‚ â† Ğ’Ğ¡Ğ¯ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°
     â”‚                 â”‚                  â”‚                 â”‚   Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ¼ĞµÑÑ‚Ğµ
     â”‚ UPDATE order    â”‚                  â”‚                 â”‚
     â”‚â”€â”€â”€â”€â–¶ trading_db â”‚                  â”‚                 â”‚
     â”‚                 â”‚                  â”‚                 â”‚
     â”‚âš ï¸ Ğ§Ñ‚Ğ¾ ĞµÑĞ»Ğ¸ ÑƒĞ¿Ğ°Ğ» â”‚                  â”‚ âœ… ĞĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼  â”‚
     â”‚   Ğ¼ĞµĞ¶Ğ´Ñƒ ÑˆĞ°Ğ³Ğ°Ğ¼Ğ¸? â”‚                  â”‚  ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸  â”‚

  * Trading Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ idempotency_keys, Ğ½Ğµ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
```

### ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿: Single Source of Truth

| Ğ¡ÑƒÑ‰Ğ½Ğ¾ÑÑ‚ÑŒ | Ğ’Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† | ĞĞ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ |
|----------|----------|-------------|
| Order | Broker Service | ĞĞ´Ğ¸Ğ½ Ğ²Ğ»Ğ°Ğ´ĞµĞ»ĞµÑ† = Ğ½ĞµÑ‚ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ğ¾Ğ¹ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¸ |
| Balance | Broker Service | Ğ ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ + ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ°Ñ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾ |
| Position | Broker Service | ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ñ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ğ¾ Ñ Ğ¾Ñ€Ğ´ĞµÑ€Ğ¾Ğ¼ |
| Idempotency | Trading Service | Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ´ÑƒĞ±Ğ»ĞµĞ¹ Ğ½Ğ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ API Gateway |
| User | Auth Service | Ğ˜Ğ·Ğ¾Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ bounded context |
| Account | Auth Service | Ğ¡Ğ²ÑĞ·Ğ°Ğ½ Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼ |

### Ğ’Ğ¼ĞµÑÑ‚Ğ¾ Saga: Fail-Fast

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FAIL-FAST VALIDATION                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        Broker Service
                              â”‚
    order.create â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 1. Check balanceâ”‚â”€â”€â”€â”€ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾? â†’ REJECTED
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ OK
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 2. Check positionâ”‚â”€â”€â”€â”€ ĞĞµÑ‚ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸? â†’ REJECTED
                    â”‚    (Ğ´Ğ»Ñ SELL)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ OK
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ 3. Reserve funds  â”‚
                    â”‚ 4. Execute order  â”‚
                    â”‚ 5. Update positionâ”‚
                    â”‚ 6. Commit/Release â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    order.filled / order.rejected
```

**ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ğµ:** ĞœÑ‹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ’Ğ¡Ğ• ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ”Ğ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸, Ğ° Ğ½Ğµ Ğ¾Ñ‚ĞºĞ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞŸĞĞ¡Ğ›Ğ• Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸.

### Trade-offs

| Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ | ĞŸĞ»ÑÑÑ‹ | ĞœĞ¸Ğ½ÑƒÑÑ‹ |
|---------|-------|--------|
| Order Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Broker | ĞĞµÑ‚ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ñ‹Ñ… Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸Ğ¹ | Trading Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ğ¾ |
| Trading = Stateless | Ğ›ĞµĞ³ĞºĞ¾ Ğ¼Ğ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ | ĞŸÑ€Ğ¸ Ğ¾Ğ±Ñ€Ñ‹Ğ²Ğµ ÑĞ²ÑĞ·Ğ¸ Ñ Broker â€” UI Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ |
| Fail-fast Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ | ĞĞµÑ‚ Ğ¾Ñ‚ĞºĞ°Ñ‚Ğ¾Ğ², Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ | ĞœĞµĞ½ÑŒÑˆĞµ Ğ³Ğ¸Ğ±ĞºĞ¾ÑÑ‚Ğ¸ |

---

## ğŸ¯ ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²

| ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ | Ğ“Ğ´Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------------|----------|
| **Microservices** | Ğ’ĞµÑÑŒ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚ | 3 Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ñ‹Ñ… ÑĞµÑ€Ğ²Ğ¸ÑĞ° Ñ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ‘Ğ” |
| **API Gateway** | Trading Service | Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ²Ñ…Ğ¾Ğ´Ğ°, Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ, Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ |
| **Database per Service** | auth_db, trading_db, broker_db | Ğ˜Ğ·Ğ¾Ğ»ÑÑ†Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ |
| **Event-Driven** | RabbitMQ | ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ |
| **CQRS** | Trading + Broker | ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ, Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ñ‡ĞµÑ€ĞµĞ· HTTP |

### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹

| ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ | Ğ“Ğ´Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------------|----------|
| **Hexagonal Architecture** | Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ | Ports & Adapters, Ğ¸Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ |
| **Dependency Injection** | Boost.DI | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ² App ĞºĞ»Ğ°ÑÑĞ°Ñ… |
| **Repository** | Postgres*Repository | ĞĞ±ÑÑ‚Ñ€Ğ°ĞºÑ†Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ |
| **Proxy** | CachedBrokerGateway | ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… HttpBrokerGateway |

### ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ½Ğ°Ğ´Ñ‘Ğ¶Ğ½Ğ¾ÑÑ‚Ğ¸

| ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ | Ğ“Ğ´Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------------|----------|
| **Idempotent Consumer** | IdempotentHandler | Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² |
| **Fail-Fast** | OrderCommandHandler | ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğ¹ Ğ´Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ |
| **Correlation ID** | order_id Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸ÑÑ… | ĞÑ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ñ‡ĞµÑ€ĞµĞ· ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ |

### Idempotency (Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IDEMPOTENCY PATTERN                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Client                  IdempotentHandler              OrderHandler
    â”‚                           â”‚                             â”‚
    â”‚ POST /orders              â”‚                             â”‚
    â”‚ X-Idempotency-Key: abc123 â”‚                             â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
    â”‚                           â”‚                             â”‚
    â”‚                           â”‚ Check DB: key exists?       â”‚
    â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                           â”‚ NO                          â”‚
    â”‚                           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                           â”‚                             â”‚
    â”‚                           â”‚ Execute â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                           â”‚                             â”‚
    â”‚                           â”‚ Save: key â†’ {status, body}  â”‚
    â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                           â”‚                             â”‚
    â”‚ 201 {order_id: xxx}       â”‚                             â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
    â”‚                           â”‚                             â”‚
    â”‚ POST /orders (RETRY)      â”‚                             â”‚
    â”‚ X-Idempotency-Key: abc123 â”‚                             â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                             â”‚
    â”‚                           â”‚                             â”‚
    â”‚                           â”‚ Check DB: key exists?       â”‚
    â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚                           â”‚ YES â†’ cached response       â”‚
    â”‚                           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                           â”‚                             â”‚
    â”‚ 201 {order_id: xxx}       â”‚ (same response, no execute) â”‚
    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                             â”‚
```

**Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ:** Ğ”ĞµĞºĞ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€ `IdempotentHandler` Ğ¾Ğ±Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ `OrderHandler`:
- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº `X-Idempotency-Key`
- ĞšÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‚Ñ‹ (2xx) Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ `idempotency_keys`
- ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚

---

## ğŸ—„ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### Auth Service (auth_db)

```sql
-- ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸
CREATE TABLE users (
    user_id VARCHAR(64) PRIMARY KEY,
    username VARCHAR(64) UNIQUE NOT NULL,
    email VARCHAR(128) UNIQUE NOT NULL,
    password_hash VARCHAR(256) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Ğ‘Ñ€Ğ¾ĞºĞµÑ€ÑĞºĞ¸Ğµ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ñ‹
CREATE TABLE accounts (
    account_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64) REFERENCES users(user_id),
    name VARCHAR(64) NOT NULL,
    type VARCHAR(16) NOT NULL,  -- SANDBOX / REAL
    tinkoff_token_encrypted TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Ğ¡ĞµÑÑĞ¸Ğ¸
CREATE TABLE sessions (
    session_id VARCHAR(64) PRIMARY KEY,
    user_id VARCHAR(64) REFERENCES users(user_id),
    jwt_token VARCHAR(512) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Trading Service (trading_db)

```sql
-- Ğ˜Ğ´ĞµĞ¼Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ‚Ğ½Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
CREATE TABLE idempotency_keys (
    key VARCHAR(64) PRIMARY KEY,
    response_status INTEGER NOT NULL,
    response_body TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Broker Service (broker_db)

```sql
-- Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹
CREATE TABLE instruments (
    figi VARCHAR(12) PRIMARY KEY,
    ticker VARCHAR(10) NOT NULL,
    name VARCHAR(256) NOT NULL,
    currency VARCHAR(3) DEFAULT 'RUB',
    lot_size INTEGER DEFAULT 1,
    min_price_increment INTEGER DEFAULT 100
);

-- ĞšĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸
CREATE TABLE quotes (
    figi VARCHAR(12) PRIMARY KEY REFERENCES instruments(figi),
    bid BIGINT NOT NULL,
    ask BIGINT NOT NULL,
    last_price BIGINT NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ĞÑ€Ğ´ĞµÑ€Ğ°
CREATE TABLE broker_orders (
    order_id VARCHAR(64) PRIMARY KEY,
    account_id VARCHAR(64) NOT NULL,
    figi VARCHAR(12) NOT NULL,
    direction VARCHAR(4) NOT NULL,      -- BUY / SELL
    quantity INTEGER NOT NULL,
    filled_quantity INTEGER DEFAULT 0,
    price BIGINT NOT NULL,              -- Ğ² ĞºĞ¾Ğ¿ĞµĞ¹ĞºĞ°Ñ…
    order_type VARCHAR(8) NOT NULL,     -- MARKET / LIMIT
    status VARCHAR(20) NOT NULL,        -- PENDING / FILLED / PARTIALLY_FILLED / REJECTED / CANCELLED
    reject_reason VARCHAR(256),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
CREATE TABLE broker_positions (
    account_id VARCHAR(64) NOT NULL,
    figi VARCHAR(12) NOT NULL,
    quantity INTEGER NOT NULL,
    avg_price BIGINT NOT NULL,          -- Ğ² ĞºĞ¾Ğ¿ĞµĞ¹ĞºĞ°Ñ…
    updated_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY(account_id, figi)
);

-- Ğ‘Ğ°Ğ»Ğ°Ğ½ÑÑ‹
CREATE TABLE broker_balances (
    account_id VARCHAR(64) PRIMARY KEY,
    currency VARCHAR(3) NOT NULL DEFAULT 'RUB',
    available BIGINT NOT NULL DEFAULT 0,  -- Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ (ĞºĞ¾Ğ¿ĞµĞ¹ĞºĞ¸)
    reserved BIGINT NOT NULL DEFAULT 0,   -- Ğ·Ğ°Ñ€ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ Ğ¾Ñ€Ğ´ĞµÑ€Ğ° (ĞºĞ¾Ğ¿ĞµĞ¹ĞºĞ¸)
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### Ğ ĞµĞ·ĞµÑ€Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   BALANCE RESERVATION FLOW                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ĞĞ°Ñ‡Ğ°Ğ»Ğ¾: available = 1,000,000â‚½, reserved = 0â‚½

1. BUY 10 Ğ»Ğ¾Ñ‚Ğ¾Ğ² SBER @ 265â‚½
   cost = 10 Ã— 10 Ã— 265 = 26,500â‚½
   
   reserve(26,500):
   â”œâ”€â”€ available = 1,000,000 - 26,500 = 973,500â‚½
   â””â”€â”€ reserved  = 0 + 26,500 = 26,500â‚½

2a. FILLED:
    commitReserved(26,500):
    â””â”€â”€ reserved = 26,500 - 26,500 = 0â‚½
    (Ğ´ĞµĞ½ÑŒĞ³Ğ¸ ÑƒÑˆĞ»Ğ¸ Ğ½Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºÑƒ Ğ°ĞºÑ†Ğ¸Ğ¹)

2b. REJECTED / CANCELLED:
    releaseReserved(26,500):
    â”œâ”€â”€ reserved  = 26,500 - 26,500 = 0â‚½
    â””â”€â”€ available = 973,500 + 26,500 = 1,000,000â‚½
    (Ğ´ĞµĞ½ÑŒĞ³Ğ¸ Ğ²ĞµÑ€Ğ½ÑƒĞ»Ğ¸ÑÑŒ)

2c. PARTIALLY_FILLED (50%):
    filled_cost = 5 Ã— 10 Ã— 265 = 13,250â‚½
    commitReserved(13,250):
    â””â”€â”€ reserved = 26,500 - 13,250 = 13,250â‚½
    (Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ¶Ğ´Ñ‘Ñ‚ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ)
```

---

## ğŸ“¡ API Reference

### Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°

```http
POST /trading/api/v1/orders
Authorization: Bearer <access_token>
Content-Type: application/json
X-Idempotency-Key: unique-key-123

{
  "figi": "BBG004730N88",
  "quantity": 10,
  "direction": "BUY",
  "type": "MARKET"
}
```

**Response (201):**
```json
{
  "order_id": "ord-abc123",
  "status": "PENDING",
  "message": "Order submitted for processing"
}
```

### Limit Order

```http
POST /trading/api/v1/orders
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "figi": "BBG004730N88",
  "quantity": 10,
  "direction": "BUY",
  "type": "LIMIT",
  "price": 265.50
}
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ:** `price` Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½ Ğ´Ğ»Ñ LIMIT, Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ MARKET.

### ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¾Ñ€Ğ´ĞµÑ€Ğ°

```http
GET /trading/api/v1/orders/ord-abc123
Authorization: Bearer <access_token>
```

**Response (200):**
```json
{
  "order_id": "ord-abc123",
  "figi": "BBG004730N88",
  "direction": "BUY",
  "type": "MARKET",
  "quantity": 10,
  "filled_quantity": 10,
  "status": "FILLED",
  "executed_price": 265.75,
  "created_at": "2025-01-04T12:00:00Z"
}
```

### ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ñ€Ñ‚Ñ„Ğ¾Ğ»Ğ¸Ğ¾

```http
GET /trading/api/v1/portfolio
Authorization: Bearer <access_token>
```

**Response (200):**
```json
{
  "account_id": "acc-sandbox-001",
  "cash": {
    "amount": 973500.00,
    "currency": "RUB"
  },
  "positions": [
    {
      "figi": "BBG004730N88",
      "ticker": "SBER",
      "quantity": 100,
      "average_price": 265.75,
      "current_price": 268.00,
      "expected_yield": 225.00
    }
  ],
  "total_value": 1000300.00
}
```

### ĞšĞ¾Ğ´Ñ‹ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº

| ĞšĞ¾Ğ´ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ |
|-----|----------|--------|
| 400 | ĞĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ | Missing FIGI, quantity <= 0 |
| 401 | ĞĞµ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½ | ĞĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸Ğ»Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´ĞµĞ½ |
| 404 | ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ | ĞÑ€Ğ´ĞµÑ€ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ |
| 500 | Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° | Database connection failed |

---

## ğŸ”¨ Makefile ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹

### Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ¸ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹

| ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|
| `make build` | Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ |
| `make push` | Ğ—Ğ°Ğ¿ÑƒÑˆĞ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ Ğ² Docker Hub |
| `make deploy` | ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ k8s Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ñ‹ (`kubectl apply -k k8s/`) |
| `make ship` | build + push + deploy (Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ») |
| `make ship-auth` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ auth-service |
| `make ship-trading` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ trading-service |
| `make ship-broker` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ broker-service |
| `make ship-ui` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Trading UI |

### Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

| ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|
| `make test-e2e` | E2E Ñ‚ĞµÑÑ‚Ñ‹ (Postman/Newman) |
| `make test-e2e-debug` | E2E + Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸ |
| `make test-trading` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµÑÑ‚Ñ‹ Trading Service |
| `make test-broker` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµÑÑ‚Ñ‹ Broker Service |

### Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

| ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|
| `make logs` | Ğ›Ğ¾Ğ³Ğ¸ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² |
| `make logs-trading` | Ğ›Ğ¾Ğ³Ğ¸ Trading Service |
| `make logs-broker` | Ğ›Ğ¾Ğ³Ğ¸ Broker Service |
| `make status` | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´Ğ¾Ğ² Ğ² namespace trading |
| `make reset-dbs` | Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ‘Ğ” Ğº Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ |
| `make restart` | ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… deployments |

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

```bash
# ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
make deploy

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ‡Ñ‚Ğ¾ Ğ²ÑÑ‘ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
make status
make test-e2e

# ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°Ñ…
make logs
```

---

## ğŸ§ª E2E Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸

### ĞĞ±Ğ·Ğ¾Ñ€

Trading Service E2E Tests v2.3 â€” Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ‚ĞµÑÑ‚Ñ‹ Ñ‡ĞµÑ€ĞµĞ· Postman/Newman.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚         executed â”‚          failed â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              iterations â”‚                1 â”‚               0 â”‚
â”‚                requests â”‚               32 â”‚               0 â”‚
â”‚              assertions â”‚               52 â”‚               0 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ total run duration: 4.7s                                     â”‚
â”‚ average response time: 10ms [min: 1ms, max: 24ms]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸

| # | Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Assertions |
|---|----------|----------|------------|
| 0 | **Setup - Authentication** | Register â†’ Login â†’ Get Access Token | 9 |
| 1 | **Initial State** | ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ (100,000 RUB) | 2 |
| 2 | **Market Order (SBER)** | `immediate` â†’ PENDING â†’ FILLED | 5 |
| 3 | **Order Rejection (GAZP)** | `alwaysReject` â†’ REJECTED | 5 |
| 4 | **Cancel Order (LKOH)** | `delayed(5s)` â†’ PENDING â†’ Cancel â†’ CANCELLED | 5 |
| 5 | **Partial Fill (MGNT)** | `partialFill(50%)` â†’ PARTIALLY_FILLED (5/10) | 5 |
| 6 | **Limit Order (YNDX)** | `realistic` â†’ LIMIT â†’ FILLED | 5 |
| 7 | **Idempotency** | ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ X-Idempotency-Key â†’ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ order_id | 5 |
| 8 | **Negative Tests** | 401 No Auth, 400 Invalid Body, 404 Not Found | 3 |
| 9 | **Final State** | ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²ÑĞµÑ… Ğ¾Ñ€Ğ´ĞµÑ€Ğ¾Ğ² Ğ¸ Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ | 4 |
| 10 | **Metrics** | Prometheus Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (orders_created, orders_filled, etc.) | 2 |
| | **Total** | | **52** |

### Ğ—Ğ°Ğ¿ÑƒÑĞº

```bash
# Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
make test-e2e

# Ğ¡ Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ñ‹Ğ¼ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¾Ğ¼
make test-e2e-debug

# Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Trading Service Ñ‚ĞµÑÑ‚Ñ‹
make test-trading
```

----

## ğŸš€ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ€Ñ‚

### Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

- Kubernetes (minikube / k3s / Docker Desktop)
- kubectl
- ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ingress Ñ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ¾Ğ¼ `arch.homework`

### Ğ Ğ°Ğ·Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ ÑƒĞ¶Ğµ Ğ² DockerHub)

```bash
# 1. ĞšĞ»Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
git clone https://github.com/tobantal/trading-platform.git
cd trading-platform/education

# 2. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ñ‹
# Ñ Kustomize
kubectl apply -k k8s/

# Ğ˜Ğ»Ğ¸ Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ° (Ğ±ĞµĞ· Kustomize)
# kubectl apply -f k8s/
# Ğ¸Ğ»Ğ¸ make deploy

# 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ (Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒ 1-2 Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñ‹)
kubectl get pods -n trading
# Ğ¸Ğ»Ğ¸ make status

# 4. ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ health endpoints
curl http://arch.homework/auth/health
curl http://arch.homework/trading/health
curl http://arch.homework/broker/health

# 5. UI Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
open http://arch.homework/ui
```

### Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ğ¼

| Ğ¡ĞµÑ€Ğ²Ğ¸Ñ | URL |
|--------|-----|
| Trading UI | http://arch.homework/ui |
| Auth API | http://arch.homework/auth |
| Trading API | http://arch.homework/trading |
| Broker API | http://arch.homework/broker |
| RabbitMQ UI | http://arch.homework/rabbitmq |
| Prometheus | http://arch.homework/prometheus |
| Grafana | http://arch.homework/grafana |

---

### Ğ—Ğ°Ğ¿ÑƒÑĞº E2E Ñ‚ĞµÑÑ‚Ğ¾Ğ²

```bash
# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Newman (ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚)
npm install -g newman

# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹
newman run postman/trading-service-e2e.postman_collection.json
# Ğ¸Ğ»Ğ¸ make test-e2e
```
----

## ğŸ¯ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ¸ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### ĞœĞ°Ğ¿Ğ¿Ğ¸Ğ½Ğ³ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ½Ğ° Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ

ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ¸Ğ¼ĞµĞµÑ‚ Ğ¿Ñ€ĞµĞ´Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ñ‘Ğ½Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:

```
SBER (BBG004730N88) â”€â”€â”€â”€â”€â”€â–¶ immediate()      â”€â”€â–¶ Market Order Flow
GAZP (BBG004730RP0) â”€â”€â”€â”€â”€â”€â–¶ alwaysReject()   â”€â”€â–¶ Order Rejection
LKOH (BBG004731032) â”€â”€â”€â”€â”€â”€â–¶ delayed(5s)      â”€â”€â–¶ Cancel Order
MGNT (BBG004RVFCY3) â”€â”€â”€â”€â”€â”€â–¶ partialFill(50%) â”€â”€â–¶ Partial Fill
YNDX (BBG006L8G4H1) â”€â”€â”€â”€â”€â”€â–¶ realistic()      â”€â”€â–¶ Limit Order
```

### Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ñ

| Ticker | FIGI | Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞµĞ¹Ñ |
|--------|------|----------|----------|---------------|
| **SBER** | BBG004730N88 | `immediate` | ĞœĞ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ | Happy path |
| **GAZP** | BBG004730RP0 | `alwaysReject` | Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ÑĞµÑ‚ | ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº |
| **LKOH** | BBG004731032 | `delayed(5s)` | Pending â†’ Filled Ñ‡ĞµÑ€ĞµĞ· 5 ÑĞµĞº | ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ·Ğ°ÑĞ²ĞºĞ¸ |
| **MGNT** | BBG004RVFCY3 | `partialFill(50%)` | Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ | PARTIALLY_FILLED |
| **YNDX** | BBG006L8G4H1 | `realistic` | Ğ ĞµĞ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ | LIMIT Ğ¾Ñ€Ğ´ĞµÑ€Ğ° |

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ñ‹Ğµ Ñ†ĞµĞ½Ñ‹

| Ticker | Ğ¦ĞµĞ½Ğ° (RUB) | Ğ›Ğ¾Ñ‚ | ĞœĞ¸Ğ½. ÑÑƒĞ¼Ğ¼Ğ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸ |
|--------|------------|-----|-------------------|
| SBER | ~294 | 10 | ~2,940 RUB |
| GAZP | ~160 | 10 | ~1,600 RUB |
| YNDX | ~3,500 | 1 | ~3,500 RUB |
| LKOH | ~7,200 | 1 | ~7,200 RUB |
| MGNT | ~5,500 | 1 | ~5,500 RUB |

### ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ° Ğ² UI

```
SBER: instant â€¢ GAZP: reject â€¢ YNDX: realistic â€¢ LKOH: 5s pending â€¢ MGNT: partial 50%
```

## ğŸ‘¨â€ğŸ« Ğ ÑƒĞºĞ¾Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ¿Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

### Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ

**ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ:**
- Username: `testuser`
- Password: `test123`

**ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Sandbox:** 100,000 RUB

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 1: ĞœĞ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ (SBER)

| ĞŸĞ¾Ğ»Ğµ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------|----------|
| Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ | SBER |
| ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ | BUY |
| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | 1 Ğ»Ğ¾Ñ‚ |
| Ğ¢Ğ¸Ğ¿ | MARKET |

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾:**
- âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: **FILLED**
- âœ… Ğ¦ĞµĞ½Ğ°: ~294 RUB
- âœ… ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ: SBER, qty=10
- âœ… Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: -2,940 RUB

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 2: ĞÑ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ (GAZP)

| ĞŸĞ¾Ğ»Ğµ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------|----------|
| Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ | GAZP |
| ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ | BUY |
| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | 1 Ğ»Ğ¾Ñ‚ |
| Ğ¢Ğ¸Ğ¿ | MARKET |

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾:**
- âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: **REJECTED**
- âœ… Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
- âœ… Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 3a: Pending + Cancel (LKOH)

| ĞŸĞ¾Ğ»Ğµ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------|----------|
| Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ | LKOH |
| ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ | BUY |
| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | 1 Ğ»Ğ¾Ñ‚ |
| Ğ¢Ğ¸Ğ¿ | MARKET |

**Ğ¨Ğ°Ğ³Ğ¸:**
1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ€Ğ´ĞµÑ€
2. **Ğ’ Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ 5 ÑĞµĞºÑƒĞ½Ğ´** Ğ½Ğ°Ğ¶Ğ°Ñ‚ÑŒ Cancel

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾:**
- âœ… Ğ¡Ñ€Ğ°Ğ·Ñƒ: **PENDING**
- âœ… ĞŸĞ¾ÑĞ»Ğµ Cancel: **CANCELLED**
- âœ… Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ Ğ½Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 3b: Pending + Fill (LKOH)

**Ğ¨Ğ°Ğ³Ğ¸:**
1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¾Ñ€Ğ´ĞµÑ€ LKOH (MARKET, BUY, 1 Ğ»Ğ¾Ñ‚)
2. ĞŸĞ¾Ğ´Ğ¾Ğ¶Ğ´Ğ°Ñ‚ÑŒ 5+ ÑĞµĞºÑƒĞ½Ğ´

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾:**
- âœ… Ğ¡Ñ€Ğ°Ğ·Ñƒ: **PENDING**
- âœ… Ğ§ĞµÑ€ĞµĞ· 5 ÑĞµĞº: **FILLED**
- âœ… ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ: LKOH, qty=1
- âœ… Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ: -7,200 RUB

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 4: Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ (MGNT)

| ĞŸĞ¾Ğ»Ğµ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------|----------|
| Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ | MGNT |
| ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ | BUY |
| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | 2 Ğ»Ğ¾Ñ‚Ğ° |
| Ğ¢Ğ¸Ğ¿ | MARKET |

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾:**
- âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: **PARTIALLY_FILLED**
- âœ… Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¾: 1 Ğ¸Ğ· 2 (50%)
- âœ… ĞŸĞ¾Ğ·Ğ¸Ñ†Ğ¸Ñ: MGNT, qty=1

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 5: LIMIT Ğ¾Ñ€Ğ´ĞµÑ€ (YNDX)

| ĞŸĞ¾Ğ»Ğµ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------|----------|
| Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ | YNDX |
| ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ | BUY |
| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | 1 Ğ»Ğ¾Ñ‚ |
| Ğ¢Ğ¸Ğ¿ | LIMIT |
| Ğ¦ĞµĞ½Ğ° | 3600 (Ğ²Ñ‹ÑˆĞµ Ñ€Ñ‹Ğ½ĞºĞ°) |

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾:**
- âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: **FILLED** (ÑÑ€Ğ°Ğ·Ñƒ, Ñ‚.Ğº. Ñ†ĞµĞ½Ğ° Ğ²Ñ‹Ğ³Ğ¾Ğ´Ğ½Ğ°Ñ)
- âœ… Ğ¦ĞµĞ½Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ: Ñ€Ñ‹Ğ½Ğ¾Ñ‡Ğ½Ğ°Ñ (~3500)

---

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹ 6: ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ÑÑ€ĞµĞ´ÑÑ‚Ğ²

| ĞŸĞ¾Ğ»Ğµ | Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------|----------|
| Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ | LKOH |
| ĞĞ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ | BUY |
| ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | 20 Ğ»Ğ¾Ñ‚Ğ¾Ğ² |
| Ğ¢Ğ¸Ğ¿ | MARKET |

**ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾:**
- âœ… Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: **REJECTED**
- âœ… Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: "Insufficient funds"

---

### Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚

- [ ] Ğ’Ñ…Ğ¾Ğ´: `testuser` / `test123`
- [ ] Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Sandbox Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°
- [ ] ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸ ĞºĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ¾Ğº
- [ ] ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° SBER â†’ FILLED
- [ ] ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° GAZP â†’ REJECTED
- [ ] ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° LKOH â†’ PENDING â†’ Cancel â†’ CANCELLED
- [ ] ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° LKOH â†’ PENDING â†’ Wait â†’ FILLED
- [ ] ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ° MGNT â†’ PARTIALLY_FILLED
- [ ] LIMIT Ğ¾Ñ€Ğ´ĞµÑ€ YNDX
- [ ] ĞŸÑ€Ğ¾Ğ´Ğ°Ğ¶Ğ° Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ğ¸
- [ ] ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¾Ñ€Ğ´ĞµÑ€Ğ¾Ğ²
- [ ] ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ P&L Ğ¿Ğ¾Ñ€Ñ‚Ñ„ĞµĞ»Ñ

---

## ğŸ“Š ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

### Ğ­Ğ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ñ‹

| Ğ¡ĞµÑ€Ğ²Ğ¸Ñ | Health | Metrics |
|--------|--------|---------|
| Auth | `/health` | `/metrics` |
| Trading | `/health` | `/metrics` |
| Broker | `/health` | `/metrics` |

### ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (Prometheus format)

```
# HTTP Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
http_requests_total{method="GET",path="/api/v1/portfolio"} 5082
http_requests_total{method="GET",path="/api/v1/orders"} 5095
http_requests_total{method="POST",path="/api/v1/orders"} 59
http_requests_total{method="DELETE",path="/api/v1/orders"} 10
http_requests_total{method="GET",path="/api/v1/instruments"} 27
http_requests_total{method="GET",path="/api/v1/quotes"} 5041

# RabbitMQ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸
events_received_total{event="order.created"} 54
events_received_total{event="order.filled"} 35
events_received_total{event="order.rejected"} 5
events_received_total{event="order.cancelled"} 8
events_received_total{event="portfolio.updated"} 35
```

---

## ğŸ›  Ğ Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°

### Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

- CMake 3.16+
- GCC 12+ / Clang 14+
- Docker & Docker Compose
- Kubernetes + kubectl
- Make

### Ğ¡Ğ±Ğ¾Ñ€ĞºĞ°

```bash
# Ğ˜Ğ· ĞºĞ¾Ñ€Ğ½Ñ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
mkdir build && cd build
cmake -DBUILD_TESTS=ON ..
make -j$(nproc)

# Ğ—Ğ°Ğ¿ÑƒÑĞº unit-Ñ‚ĞµÑÑ‚Ğ¾Ğ²
ctest --output-on-failure
```

### Makefile ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ (Ğ´Ğ»Ñ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ°)

| ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|---------|----------|
| `make build` | Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Docker Ğ¾Ğ±Ñ€Ğ°Ğ·Ñ‹ |
| `make push` | ĞŸÑƒÑˆĞ½ÑƒÑ‚ÑŒ Ğ² Docker Hub |
| `make deploy` | ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ k8s Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ñ‹ |
| `make ship` | build + push + redeploy Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² |
| `make ship-auth` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ auth-service |
| `make ship-trading` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ trading-service |
| `make ship-broker` | Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ broker-service |
| `make test-e2e` | E2E Ñ‚ĞµÑÑ‚Ñ‹ (Postman/Newman) |
| `make test-e2e-debug` | E2E + Ğ»Ğ¾Ğ³Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸ |
| `make reset-dbs` | Ğ¡Ğ±Ñ€Ğ¾Ñ Ğ‘Ğ” Ğº Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¼Ñƒ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ |
| `make logs` | Ğ›Ğ¾Ğ³Ğ¸ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ² |
| `make status` | Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾Ğ´Ğ¾Ğ² |

### ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ

**Auth Service:**

| ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ | Default | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------------|---------|----------|
| `HTTP_PORT` | 8081 | ĞŸĞ¾Ñ€Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ° |
| `AUTH_DB_HOST` | localhost | Ğ¥Ğ¾ÑÑ‚ PostgreSQL |
| `AUTH_DB_PORT` | 5432 | ĞŸĞ¾Ñ€Ñ‚ PostgreSQL |
| `AUTH_DB_NAME` | auth_db | Ğ˜Ğ¼Ñ Ğ‘Ğ” |
| `AUTH_DB_USER` | auth_user | ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ |
| `AUTH_DB_PASSWORD` | - | ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ (Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾) |

**Trading Service:**

| ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ | Default | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------------|---------|----------|
| `HTTP_PORT` | 8082 | ĞŸĞ¾Ñ€Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ° |
| `AUTH_SERVICE_HOST` | auth-service | Ğ¥Ğ¾ÑÑ‚ Auth |
| `AUTH_SERVICE_PORT` | 8081 | ĞŸĞ¾Ñ€Ñ‚ Auth |
| `BROKER_SERVICE_HOST` | broker-service | Ğ¥Ğ¾ÑÑ‚ Broker |
| `BROKER_SERVICE_PORT` | 8083 | ĞŸĞ¾Ñ€Ñ‚ Broker |
| `RABBITMQ_HOST` | rabbitmq | Ğ¥Ğ¾ÑÑ‚ RabbitMQ |
| `RABBITMQ_PORT` | 5672 | ĞŸĞ¾Ñ€Ñ‚ RabbitMQ |
| `TRADING_DB_HOST` | trading-postgres | Ğ¥Ğ¾ÑÑ‚ PostgreSQL |
| `TRADING_DB_PORT` | 5432 | ĞŸĞ¾Ñ€Ñ‚ PostgreSQL |
| `TRADING_DB_NAME` | trading_db | Ğ˜Ğ¼Ñ Ğ‘Ğ” |

**Broker Service:**

| ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ | Default | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------------|---------|----------|
| `HTTP_PORT` | 8083 | ĞŸĞ¾Ñ€Ñ‚ ÑĞµÑ€Ğ²ĞµÑ€Ğ° |
| `DB_HOST` | localhost | Ğ¥Ğ¾ÑÑ‚ PostgreSQL |
| `DB_PORT` | 5432 | ĞŸĞ¾Ñ€Ñ‚ PostgreSQL |
| `DB_NAME` | broker_db | Ğ˜Ğ¼Ñ Ğ‘Ğ” |
| `RABBITMQ_HOST` | rabbitmq | Ğ¥Ğ¾ÑÑ‚ RabbitMQ |
| `BROKER_FILL_BEHAVIOR` | REALISTIC | Ğ ĞµĞ¶Ğ¸Ğ¼ ÑĞ¸Ğ¼ÑƒĞ»ÑÑ†Ğ¸Ğ¸ |

---

## ğŸ”§ Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸

### Ğ¡Ğ¾Ğ±ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸

| Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|------------|----------|
| [cpp-http-server](https://github.com/...) | HTTP ÑĞµÑ€Ğ²ĞµÑ€ Ğ½Ğ° Boost.Beast + Boost.DI |
| [cpp-cache](https://github.com/...) | Fast Thread-safe LRU ĞºÑÑˆ Ğ½Ğ° Ñ‡Ğ¸ÑÑ‚Ğ¾Ğ¼ C++ |

### Backend

| Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ | Ğ’ĞµÑ€ÑĞ¸Ñ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------------|--------|------------|
| C++ | 17/20 | Ğ¯Ğ·Ñ‹Ğº Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ |
| Boost.Beast | 1.83 | HTTP Server |
| Boost.DI | 1.3 | Dependency Injection |
| Boost.Asio | 1.83 | Async I/O |
| nlohmann/json | 3.11 | JSON Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³ |
| AMQP-CPP | 4.3 | RabbitMQ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ |
| libpqxx | 7.9 | PostgreSQL ĞºĞ»Ğ¸ĞµĞ½Ñ‚ |
| GoogleTest | 1.14 | Unit Ñ‚ĞµÑÑ‚Ñ‹ |

### Ğ˜Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°

| Ğ¢ĞµÑ…Ğ½Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------------|------------|
| Docker | ĞšĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ |
| Kubernetes | ĞÑ€ĞºĞµÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ |
| Kustomize | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ k8s |
| RabbitMQ | Message Broker |
| PostgreSQL | Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… |
| nginx Ingress | Reverse Proxy |
| Prometheus | ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸ |
| Grafana | Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ |

### CI/CD

| Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ |
|------------|------------|
| GitHub Actions | CI pipeline |
| gcovr | Coverage report |

---

## ğŸ“ Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°

```
education/
â”œâ”€â”€ auth-service/
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ adapters/primary/      # HTTP handlers
â”‚   â”‚   â”œâ”€â”€ adapters/secondary/    # PostgreSQL, JWT
â”‚   â”‚   â”œâ”€â”€ application/           # AuthService, AccountService
â”‚   â”‚   â”œâ”€â”€ domain/                # User, Account, Session
â”‚   â”‚   â””â”€â”€ ports/                 # Interfaces
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ sql/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ CMakeLists.txt
â”‚
â”œâ”€â”€ trading-service/
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ adapters/primary/      # OrderHandler, MarketHandler, IdempotentHandler
â”‚   â”‚   â”œâ”€â”€ adapters/secondary/    # HttpBrokerGateway, RabbitMQ, PostgresIdempotencyRepo
â”‚   â”‚   â”œâ”€â”€ application/           # OrderService, TradingEventHandler
â”‚   â”‚   â”œâ”€â”€ domain/                # Order, Portfolio, Quote
â”‚   â”‚   â””â”€â”€ ports/                 # IBrokerGateway, IEventPublisher, IIdempotencyRepository
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ sql/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ CMakeLists.txt
â”‚
â”œâ”€â”€ broker-service/
â”‚   â”œâ”€â”€ include/
â”‚   â”‚   â”œâ”€â”€ adapters/primary/      # OrdersHandler, PortfolioHandler
â”‚   â”‚   â”œâ”€â”€ adapters/secondary/    # FakeBrokerAdapter, PostgreSQL
â”‚   â”‚   â”‚   â””â”€â”€ broker/            # OrderProcessor, PriceSimulator
â”‚   â”‚   â”œâ”€â”€ application/           # OrderCommandHandler
â”‚   â”‚   â”œâ”€â”€ domain/                # BrokerOrder, BrokerBalance
â”‚   â”‚   â””â”€â”€ ports/
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ sql/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ CMakeLists.txt
â”‚
â”œâ”€â”€ k8s/
â”‚   â”œâ”€â”€ namespace.yaml
â”‚   â”œâ”€â”€ secret.yaml
â”‚   â”œâ”€â”€ auth-postgres.yaml
â”‚   â”œâ”€â”€ auth-service.yaml
â”‚   â”œâ”€â”€ trading-postgres.yaml
â”‚   â”œâ”€â”€ trading-service.yaml
â”‚   â”œâ”€â”€ broker-postgres.yaml
â”‚   â”œâ”€â”€ broker-service.yaml
â”‚   â”œâ”€â”€ rabbitmq.yaml
â”‚   â””â”€â”€ ingress.yaml
â”‚
â”œâ”€â”€ postman/
â”‚   â””â”€â”€ trading-platform-e2e.json
â”‚
â”œâ”€â”€ Makefile
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ README.md
â””â”€â”€ TODO.md
```

---
