apiVersion: v1
kind: ConfigMap
metadata:
  name: broker-postgres-init
  namespace: trading
data:
  init.sql: |
    CREATE TABLE IF NOT EXISTS instruments (
        figi VARCHAR(12) PRIMARY KEY,
        ticker VARCHAR(12) NOT NULL,
        name VARCHAR(128) NOT NULL,
        currency VARCHAR(3) NOT NULL,
        lot_size INTEGER NOT NULL,
        min_price_increment BIGINT NOT NULL
    );

    CREATE TABLE IF NOT EXISTS quotes (
        figi VARCHAR(12) PRIMARY KEY REFERENCES instruments(figi),
        bid BIGINT NOT NULL,
        ask BIGINT NOT NULL,
        last_price BIGINT NOT NULL,
        updated_at TIMESTAMP DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS broker_orders (
        order_id VARCHAR(64) PRIMARY KEY,
        account_id VARCHAR(64) NOT NULL,
        figi VARCHAR(12) NOT NULL,
        direction VARCHAR(4) NOT NULL,
        quantity INTEGER NOT NULL,
        filled_quantity INTEGER DEFAULT 0,
        price BIGINT NOT NULL,
        order_type VARCHAR(8) NOT NULL,
        status VARCHAR(20) NOT NULL,
        reject_reason VARCHAR(256),
        received_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );

    CREATE TABLE IF NOT EXISTS broker_positions (
        account_id VARCHAR(64) NOT NULL,
        figi VARCHAR(12) NOT NULL,
        quantity INTEGER NOT NULL,
        avg_price BIGINT NOT NULL,
        updated_at TIMESTAMP DEFAULT NOW(),
        PRIMARY KEY(account_id, figi)
    );

    CREATE TABLE IF NOT EXISTS broker_balances (
        account_id VARCHAR(64) PRIMARY KEY,
        currency VARCHAR(3) NOT NULL DEFAULT 'RUB',
        available BIGINT NOT NULL DEFAULT 0,
        reserved BIGINT NOT NULL DEFAULT 0,
        updated_at TIMESTAMP DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_broker_orders_account_id ON broker_orders(account_id);
    CREATE INDEX IF NOT EXISTS idx_broker_orders_status ON broker_orders(status);

    -- Seed instruments
    INSERT INTO instruments (figi, ticker, name, currency, lot_size, min_price_increment) VALUES
    ('BBG004730N88', 'SBER', 'Сбербанк', 'RUB', 10, 100),
    ('BBG004730RP0', 'GAZP', 'Газпром', 'RUB', 10, 100),
    ('BBG004731032', 'LKOH', 'Лукойл', 'RUB', 1, 500),
    ('BBG004731354', 'ROSN', 'Роснефть', 'RUB', 1, 100),
    ('BBG004S68614', 'ALRS', 'Алроса', 'RUB', 10, 10)
    ON CONFLICT (figi) DO NOTHING;

    -- Seed quotes (цены в копейках)
    INSERT INTO quotes (figi, bid, ask, last_price) VALUES
    ('BBG004730N88', 26500, 26550, 26525),
    ('BBG004730RP0', 15800, 15850, 15820),
    ('BBG004731032', 710000, 710500, 710200),
    ('BBG004731354', 57500, 57600, 57550),
    ('BBG004S68614', 7200, 7250, 7220)
    ON CONFLICT (figi) DO UPDATE SET
        bid = EXCLUDED.bid,
        ask = EXCLUDED.ask,
        last_price = EXCLUDED.last_price,
        updated_at = NOW();

    -- ============================================
    -- SEED BALANCES (деньги на "бирже")
    -- ============================================
    
    -- Баланс для тестового sandbox аккаунта на бирже (100,000 ₽)
    INSERT INTO broker_balances (account_id, currency, available, reserved, updated_at) VALUES
    ('acc-sandbox-001', 'RUB', 10000000, 0, NOW())
    ON CONFLICT (account_id) DO NOTHING;
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: broker-postgres-pvc
  namespace: trading
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: broker-postgres
  namespace: trading
spec:
  replicas: 1
  selector:
    matchLabels:
      app: broker-postgres
  template:
    metadata:
      labels:
        app: broker-postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: BROKER_DB_NAME
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: BROKER_DB_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: trading-secrets
                  key: BROKER_DB_PASSWORD
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
            - name: init-sql
              mountPath: /docker-entrypoint-initdb.d
          readinessProbe:
            exec:
              command: ["pg_isready", "-U", "broker_user", "-d", "broker_db"]
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: postgres-storage
          persistentVolumeClaim:
            claimName: broker-postgres-pvc
        - name: init-sql
          configMap:
            name: broker-postgres-init
---
apiVersion: v1
kind: Service
metadata:
  name: broker-postgres
  namespace: trading
spec:
  selector:
    app: broker-postgres
  ports:
    - port: 5432
      targetPort: 5432
