# Manual Testing Guide

## Концепция имитации рынка

Trading Platform использует **поведенческое тестирование** через настройку сценариев для отдельных инструментов. Каждая акция имеет предопределённое поведение, что позволяет детерминированно тестировать различные сценарии без изменения кода.

### Альтернативные подходы (для справки)

| Подход | Паттерн | Описание | Плюсы/Минусы |
|--------|---------|----------|--------------|
| **Текущий** | Strategy | Каждый инструмент = своя стратегия исполнения | ✅ Простота, детерминизм, параллельные тесты |
| State | State | Менять состояние всего брокера между тестами | ❌ Нужен restart, нет параллельности |
| Test Endpoints | Command | REST API для управления поведением брокера | ✅ Гибкость, ❌ Сложность, безопасность |

---

## Таблица поведения инструментов

| Ticker | FIGI | Поведение | Описание | Применение |
|--------|------|-----------|----------|------------|
| **SBER** | BBG004730N88 | IMMEDIATE | Мгновенное исполнение по рыночной цене | Базовый happy-path |
| **GAZP** | BBG004730RP0 | ALWAYS_REJECT | Всегда отклоняет заявки | Тест обработки ошибок |
| **YNDX** | BBG006L8G4H1 | DELAYED (3 сек) | Pending → Filled через 3 секунды | Тест отмены заявки |
| **LKOH** | BBG004731032 | DELAYED (10 сек) | Pending → Filled через 10 секунд | Тест длительного ожидания |
| **MGNT** | BBG004RVFCY3 | PARTIAL (50%) | Частичное исполнение | Тест PARTIALLY_FILLED |

### Примерные цены (могут колебаться ±2%)

| Ticker | Цена (RUB) | Лот | Мин. сумма покупки |
|--------|------------|-----|-------------------|
| SBER | ~294 | 10 | ~2,940 RUB |
| GAZP | ~160 | 10 | ~1,600 RUB |
| YNDX | ~3,500 | 1 | ~3,500 RUB |
| LKOH | ~7,200 | 1 | ~7,200 RUB |
| MGNT | ~5,500 | 1 | ~5,500 RUB |

---

## Предустановленные данные

### Тестовый пользователь
- **Username:** `testuser`
- **Password:** `test123`
- **Email:** `test@example.com`

### Начальный баланс Sandbox аккаунта
- **100,000 RUB**

---

## Сценарии тестирования

### Подготовка

1. Открыть UI: http://arch.homework/ui/
2. Войти: `testuser` / `test123`
3. Выбрать существующий аккаунт или создать новый Sandbox

---

### Сценарий 0: Создание нового аккаунта

**Цель:** Проверить создание Sandbox аккаунта

**Шаги:**
1. На странице "Мои аккаунты" нажать "+ Создать Sandbox"
2. Ввести название аккаунта (например, "Test-Account-1")
3. Подтвердить создание

**Ожидаемый результат:**
- ✅ Аккаунт появился в списке
- ✅ При выборе аккаунта — баланс 100,000 RUB
- ✅ Позиции пусты

---

### Сценарий 1: Мгновенное исполнение (SBER)

**Цель:** Проверить базовый flow покупки

**Шаги:**
1. Выбрать инструмент: **SBER**
2. Направление: **BUY**
3. Количество: **1** лот
4. Тип: **MARKET**
5. Нажать "Создать ордер"

**Ожидаемый результат:**
- ✅ Статус: **FILLED**
- ✅ В истории ордеров: цена ~294 RUB
- ✅ В позициях: SBER, qty=10 (1 лот × 10 бумаг)
- ✅ Баланс уменьшился на ~2,940 RUB

---

### Сценарий 2a: Отмена заявки (YNDX)

**Цель:** Проверить отмену pending ордера

**Шаги:**
1. Выбрать инструмент: **YNDX**
2. Направление: **BUY**
3. Количество: **1** лот
4. Тип: **MARKET**
5. Нажать "Создать ордер"
6. **В течение 3 секунд** нажать кнопку отмены (X)

**Ожидаемый результат:**
- ✅ Статус после создания: **PENDING**
- ✅ После отмены: **CANCELLED**
- ✅ Баланс не изменился
- ✅ Позиция не появилась

---

### Сценарий 2b: Ожидание исполнения (YNDX)

**Цель:** Проверить автоматическое исполнение после задержки

**Шаги:**
1. Выбрать инструмент: **YNDX**
2. Направление: **BUY**
3. Количество: **1** лот
4. Тип: **MARKET**
5. Нажать "Создать ордер"
6. **Подождать 3+ секунд**

**Ожидаемый результат:**
- ✅ Статус после создания: **PENDING**
- ✅ Статус через ~3 сек: **FILLED**
- ✅ В позициях: YNDX, qty=1
- ✅ Баланс уменьшился на ~3,500 RUB

---

### Сценарий 3: Отклонение заявки (GAZP)

**Цель:** Проверить обработку reject

**Шаги:**
1. Выбрать инструмент: **GAZP**
2. Направление: **BUY**
3. Количество: **1** лот
4. Тип: **MARKET**
5. Нажать "Создать ордер"

**Ожидаемый результат:**
- ✅ Статус: **REJECTED**
- ✅ Сообщение об ошибке (вверху экрана)
- ✅ Баланс не изменился
- ✅ Позиция не появилась

---

### Сценарий 4: Частичное исполнение (MGNT)

**Цель:** Проверить PARTIALLY_FILLED статус

**Шаги:**
1. Выбрать инструмент: **MGNT**
2. Направление: **BUY**
3. Количество: **2** лота
4. Тип: **MARKET**
5. Нажать "Создать ордер"

**Ожидаемый результат:**
- ✅ Статус: **PARTIALLY_FILLED**
- ✅ В истории: исполнено 1 из 2 (50%)
- ✅ В позициях: MGNT, qty=1
- ✅ Баланс уменьшился на ~5,500 RUB (за 1 лот)

---

### Сценарий 5: Продажа позиции

**Предусловие:** Есть позиция в SBER (Сценарий 1)

**Шаги:**
1. Выбрать инструмент: **SBER**
2. Направление: **SELL**
3. Количество: **1** лот
4. Тип: **MARKET**
5. Нажать "Создать ордер"

**Ожидаемый результат:**
- ✅ Статус: **FILLED**
- ✅ Позиция SBER исчезла (или qty уменьшилось)
- ✅ Баланс увеличился на ~2,940 RUB

---

### Сценарий 6: Недостаточно средств

**Цель:** Проверить валидацию баланса

**Шаги:**
1. Выбрать инструмент: **LKOH** (цена ~7,200 RUB)
2. Направление: **BUY**
3. Количество: **20** лотов (~144,000 RUB)
4. Тип: **MARKET**
5. Нажать "Создать ордер"

**Ожидаемый результат:**
- ✅ Статус: **REJECTED**
- ✅ Сообщение: "Insufficient funds"
- ✅ Баланс не изменился

---

### Сценарий 7: Продажа без позиции (Short Selling)

**Цель:** Проверить запрет коротких продаж

**Шаги:**
1. Выбрать инструмент: **GAZP** (нет позиции)
2. Направление: **SELL**
3. Количество: **1** лот
4. Тип: **MARKET**
5. Нажать "Создать ордер"

**Ожидаемый результат:**
- ✅ Статус: **REJECTED**
- ✅ Сообщение: "Insufficient position"

---

## Проверка API (Postman/curl)

### Получить котировки
```bash
curl -H "Authorization: Bearer <access_token>" \
  "http://arch.homework/trading/api/v1/quotes?figis=BBG004730N88,BBG004730RP0"
```

### Создать ордер
```bash
curl -X POST -H "Authorization: Bearer <access_token>" \
  -H "Content-Type: application/json" \
  -d '{"figi":"BBG004730N88","direction":"BUY","quantity":1,"type":"MARKET"}' \
  "http://arch.homework/trading/api/v1/orders"
```

### Отменить ордер
```bash
curl -X DELETE -H "Authorization: Bearer <access_token>" \
  "http://arch.homework/trading/api/v1/orders/<order_id>"
```

---

## Чек-лист для проверяющего

- [ ] Регистрация нового пользователя
- [ ] Создание Sandbox аккаунта
- [ ] Просмотр списка инструментов с котировками
- [ ] Покупка SBER (FILLED)
- [ ] Покупка GAZP (REJECTED)
- [ ] Покупка YNDX + отмена (CANCELLED)
- [ ] Покупка YNDX + ожидание (FILLED)
- [ ] Покупка MGNT (PARTIALLY_FILLED)
- [ ] Продажа позиции
- [ ] Просмотр истории ордеров
- [ ] Просмотр портфеля и позиций
