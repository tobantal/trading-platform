{
  "info": {
    "name": "Broker Service",
    "description": "API tests for Broker Service - Trading Platform\n\nВАЖНО: POST/DELETE /orders теперь через RabbitMQ!\nИспользуйте trading-service для создания/отмены ордеров.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://arch.homework/broker",
      "type": "string"
    },
    {
      "key": "sandbox_account",
      "value": "acc-001-sandbox",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Health & Metrics",
      "item": [
        {
          "name": "Health Check",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response has status healthy', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.eql('healthy');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/health",
              "host": ["{{base_url}}"],
              "path": ["health"]
            }
          }
        },
        {
          "name": "Prometheus Metrics",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response contains metrics', function () {",
                  "    pm.expect(pm.response.text()).to.include('http_requests_total');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/metrics",
              "host": ["{{base_url}}"],
              "path": ["metrics"]
            }
          }
        }
      ]
    },
    {
      "name": "Instruments",
      "item": [
        {
          "name": "Get All Instruments",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response is array', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('Contains SBER instrument', function () {",
                  "    var jsonData = pm.response.json();",
                  "    var sber = jsonData.find(i => i.ticker === 'SBER');",
                  "    pm.expect(sber).to.not.be.undefined;",
                  "    pm.expect(sber.figi).to.eql('BBG004730N88');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/instruments",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "instruments"]
            }
          }
        },
        {
          "name": "Get SBER Instrument",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Correct instrument returned', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.figi).to.eql('BBG004730N88');",
                  "    pm.expect(jsonData.ticker).to.eql('SBER');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/instruments/BBG004730N88",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "instruments", "BBG004730N88"]
            }
          }
        },
        {
          "name": "Get Non-Existent Instrument",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 404', function () {",
                  "    pm.response.to.have.status(404);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/instruments/INVALID_FIGI",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "instruments", "INVALID_FIGI"]
            }
          }
        }
      ]
    },
    {
      "name": "Quotes",
      "item": [
        {
          "name": "Get SBER Quote",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Quote has required fields', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.figi).to.eql('BBG004730N88');",
                  "    pm.expect(jsonData).to.have.property('bid_price');",
                  "    pm.expect(jsonData).to.have.property('ask_price');",
                  "    pm.expect(jsonData).to.have.property('last_price');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/quotes?figi=BBG004730N88",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "quotes"],
              "query": [{ "key": "figi", "value": "BBG004730N88" }]
            }
          }
        },
        {
          "name": "Get Quote - Missing FIGI",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/quotes",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "quotes"]
            }
          }
        }
      ]
    },
    {
      "name": "Orders (READ-ONLY)",
      "description": "ВАЖНО: POST/DELETE /orders теперь через RabbitMQ!\nБрокер принимает команды через очередь, не через HTTP.",
      "item": [
        {
          "name": "Get Orders (sandbox)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Response is array', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.be.an('array');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/orders?account_id={{sandbox_account}}",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "orders"],
              "query": [{ "key": "account_id", "value": "{{sandbox_account}}" }]
            }
          }
        },
        {
          "name": "Get Orders - Missing account_id",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/orders",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "orders"]
            }
          }
        },
        {
          "name": "POST Order - Returns 405 (Event-Driven)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 405 - Method Not Allowed', function () {",
                  "    pm.response.to.have.status(405);",
                  "});",
                  "",
                  "pm.test('Error message explains event-driven', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.error).to.include('event-driven');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [{ "key": "Content-Type", "value": "application/json" }],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"account_id\": \"acc-001-sandbox\",\n  \"figi\": \"BBG004730N88\",\n  \"quantity\": 10,\n  \"direction\": \"BUY\",\n  \"order_type\": \"MARKET\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/api/v1/orders",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "orders"]
            }
          }
        },
        {
          "name": "DELETE Order - Returns 405 (Event-Driven)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 405 - Method Not Allowed', function () {",
                  "    pm.response.to.have.status(405);",
                  "});",
                  "",
                  "pm.test('Error message explains event-driven', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.error).to.include('event-driven');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/orders/ord-12345?account_id={{sandbox_account}}",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "orders", "ord-12345"],
              "query": [{ "key": "account_id", "value": "{{sandbox_account}}" }]
            }
          }
        }
      ]
    },
    {
      "name": "Portfolio",
      "item": [
        {
          "name": "Get Portfolio (sandbox)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Portfolio has cash and positions', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('cash');",
                  "    pm.expect(jsonData).to.have.property('positions');",
                  "    pm.expect(jsonData).to.have.property('total_value');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/portfolio?account_id={{sandbox_account}}",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "portfolio"],
              "query": [{ "key": "account_id", "value": "{{sandbox_account}}" }]
            }
          }
        },
        {
          "name": "Get Portfolio - Missing account_id",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 400', function () {",
                  "    pm.response.to.have.status(400);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/api/v1/portfolio",
              "host": ["{{base_url}}"],
              "path": ["api", "v1", "portfolio"]
            }
          }
        }
      ]
    }
  ]
}
