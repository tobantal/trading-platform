# Trading Platform ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ v2

> **–î–∞—Ç–∞:** 2025-01-12  
> **–°—Ç–∞—Ç—É—Å:** –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ –ø–æ—Å–ª–µ –æ–±—Å—É–∂–¥–µ–Ω–∏—è  
> **–í–µ—Ä—Å–∏—è:** 2.0

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π](#–æ–±–∑–æ—Ä-–∏–∑–º–µ–Ω–µ–Ω–∏–π)
2. [–ö–æ–Ω—Ü–µ–ø—Ü–∏—è trace_id](#–∫–æ–Ω—Ü–µ–ø—Ü–∏—è-trace_id)
3. [–¢–∏–ø—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤](#—Ç–∏–ø—ã-–∞–∫–∫–∞—É–Ω—Ç–æ–≤)
4. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ broker-service](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-broker-service)
5. [–ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö](#–∏—Å—Ç–æ—á–Ω–∏–∫–∏-—Ä—ã–Ω–æ—á–Ω—ã—Ö-–¥–∞–Ω–Ω—ã—Ö)
6. [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏](#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-—Ç–æ–∫–µ–Ω–∞–º–∏)
7. [–°—Ç–∞—Ç—É—Å—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤](#—Å—Ç–∞—Ç—É—Å—ã-–∞–∫–∫–∞—É–Ω—Ç–æ–≤)
8. [–ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è](#–±—É–¥—É—â–∏–µ-—É–ª—É—á—à–µ–Ω–∏—è)

---

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è

| –¢–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ |
|------|---------|
| –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—Ä–¥–µ—Ä–æ–≤ | `trace_id` (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π) + `order_id` (–±—Ä–æ–∫–µ—Ä—Å–∫–∏–π) |
| –¢–∏–ø—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤ | `fake` / `sandbox` / `real` |
| –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±—Ä–æ–∫–µ—Ä–∞ | –û–¥–∏–Ω —Å–µ—Ä–≤–∏—Å, —Ä–µ–∂–∏–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–∏–ø–æ–º –∞–∫–∫–∞—É–Ω—Ç–∞ |
| –î–∞–Ω–Ω—ã–µ –¥–ª—è fake | –†–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–æ–∫–µ–Ω |
| –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ | –°–µ—Ä–≤–∏—Å keepalive —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ |

### –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç

1. **Distributed Tracing** ‚Äî –µ–¥–∏–Ω—ã–π trace_id –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
2. **–£–ø—Ä–æ—â–µ–Ω–∏–µ –∫–æ–¥–∞** ‚Äî –Ω–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –º–∞–ø–ø–∏–Ω–≥–∞ order_id
3. **–ì–∏–±–∫–æ—Å—Ç—å** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
4. **–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å** ‚Äî fake-—Ç–æ—Ä–≥–æ–≤–ª—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ü–µ–Ω–∞—Ö –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## –ö–æ–Ω—Ü–µ–ø—Ü–∏—è trace_id

### –ü—Ä–æ–±–ª–µ–º–∞ (–±—ã–ª–æ)

```
trading-service –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç order_id
        ‚Üì
broker-service –ø–æ–ª—É—á–∞–µ—Ç order_id
        ‚Üì
Tinkoff API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –î–†–£–ì–û–ô order_id
        ‚Üì
–ù—É–∂–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ –º–∞–ø–ø–∏–Ω–≥–∞ our_order_id ‚Üî tinkoff_order_id
```

### –†–µ—à–µ–Ω–∏–µ (—Å—Ç–∞–ª–æ)

```
trading-service –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç trace_id (UUID)
        ‚Üì
broker-service –ø–æ–ª—É—á–∞–µ—Ç trace_id, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç order_id
        ‚Üì
order_id –æ—Å—Ç–∞—ë—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ broker-service
        ‚Üì
–í–Ω–µ—à–Ω–∏–π –º–∏—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å trace_id
```

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è

| –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä | –ì–¥–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|---------------|------------------|------------|
| `trace_id` | trading-service (OrderService) | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ |
| `order_id` | broker-service –∏–ª–∏ Tinkoff API | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –æ—Ä–¥–µ—Ä–∞ —É –±—Ä–æ–∫–µ—Ä–∞ |

### trace_id = idempotency_key

–î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –æ–±—ä–µ–¥–∏–Ω—è–µ–º –¥–≤–∞ –ø–æ–Ω—è—Ç–∏—è:
- `trace_id` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- –û–Ω –∂–µ —Å–ª—É–∂–∏—Ç –∫–ª—é—á–æ–º –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–µ–π

```cpp
// –í OrderService –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ä–¥–µ—Ä–∞
std::string trace_id = generateUUID();  // –û–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –æ–±–µ–∏—Ö —Ü–µ–ª–µ–π
```

### –§–æ—Ä–º–∞—Ç

```
trace_id: UUID v4
–ü—Ä–∏–º–µ—Ä: "550e8400-e29b-41d4-a716-446655440000"
```

### –ì–¥–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è

```cpp
class OrderService {
public:
    OrderResult createOrder(const CreateOrderRequest& request) {
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º trace_id –∑–¥–µ—Å—å, –Ω–µ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
        // –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ (—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)
        std::string trace_id = generateUUID();
        
        // –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–±—ã—Ç–∏–µ —Å trace_id
        eventPublisher_->publish("order.create", {
            {"trace_id", trace_id},
            {"account_id", request.accountId},
            {"figi", request.figi},
            {"direction", request.direction},
            {"quantity", request.quantity},
            {"price", request.price}
        });
        
        return OrderResult{trace_id, OrderStatus::PENDING};
    }
};
```

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –æ—Ä–¥–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–∞–∑–±–∏–≤–∞–µ—Ç –±–æ–ª—å—à–æ–π –æ—Ä–¥–µ—Ä –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ):

```
parent_trace_id: "550e8400-..."  // –û–±—â–∏–π –¥–ª—è –≥—Ä—É–ø–ø—ã
trace_id: "660f9500-..."         // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ä–¥–µ—Ä–∞
```

–ü–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ–º ‚Äî –¥–æ–±–∞–≤–∏–º –∫–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å.

---

## –¢–∏–ø—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤

### –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ

| –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-------|----------|
| `sandbox` | `fake` | –ù–∞—à FakeBroker, –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| ‚Äî | `sandbox` | Tinkoff Sandbox API |
| ‚Äî | `real` | Tinkoff Production API |

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä | fake | sandbox | real |
|----------|------|---------|------|
| –¢–æ–∫–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | –ù–µ –Ω—É–∂–µ–Ω | –ù—É–∂–µ–Ω | –ù—É–∂–µ–Ω |
| –ò—Å—Ç–æ—á–Ω–∏–∫ —Ü–µ–Ω | Tinkoff API (—Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç–æ–∫–µ–Ω) | Tinkoff Sandbox | Tinkoff Production |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ä–¥–µ—Ä–æ–≤ | –ù–∞—à FakeBroker | Tinkoff Sandbox | Tinkoff Production |
| –†–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏ | –ù–µ—Ç | –ù–µ—Ç | –î–∞ |
| –¢—Ä–µ–±—É–µ—Ç—Å—è —Å—á—ë—Ç –≤ –¢–∏–Ω—å–∫–æ—Ñ—Ñ | –ù–µ—Ç | –î–∞ | –î–∞ |

### –§–ª–æ—É —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞

#### Fake-–∞–∫–∫–∞—É–Ω—Ç (–±–µ–∑ —Ç–æ–∫–µ–Ω–∞)

```
UI: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –¥–µ–º–æ-–∞–∫–∫–∞—É–Ω—Ç"
        ‚Üì
auth-service: –°–æ–∑–¥–∞—ë—Ç –∞–∫–∫–∞—É–Ω—Ç —Å type=FAKE
        ‚Üì
–ë–î: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–µ–∑ —Ç–æ–∫–µ–Ω–∞
```

#### Sandbox/Real –∞–∫–∫–∞—É–Ω—Ç (—Å —Ç–æ–∫–µ–Ω–æ–º)

```
UI: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–æ–∫–µ–Ω Tinkoff
        ‚Üì
auth-service: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω –≤ broker-service
        ‚Üì
broker-service: 
    1. –í—ã–∑—ã–≤–∞–µ—Ç Tinkoff API GetAccounts()
    2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞
    3. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—á–µ—Ç–æ–≤
    4. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤ auth-service
        ‚Üì
auth-service: 
    1. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–ø–∏—Å–æ–∫ —Å—á–µ—Ç–æ–≤
    2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å—á—ë—Ç
    3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç: account_type, tinkoff_account_id, encrypted_token
```

### –°—Ö–µ–º–∞ –ë–î (auth-service)

```sql
CREATE TYPE account_type AS ENUM ('fake', 'sandbox', 'real');
CREATE TYPE account_status AS ENUM ('active', 'token_invalid', 'suspended');

CREATE TABLE accounts (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id),
    type account_type NOT NULL,
    status account_status NOT NULL DEFAULT 'active',
    
    -- –¢–æ–ª—å–∫–æ –¥–ª—è sandbox/real
    tinkoff_account_id VARCHAR(64),
    encrypted_token TEXT,
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    name VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW(),
    last_used_at TIMESTAMP,
    
    CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id)
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_accounts_user_id ON accounts(user_id);
CREATE INDEX idx_accounts_status ON accounts(status);
```

---

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ broker-service

### –í—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –û–¥–∏–Ω —Å–µ—Ä–≤–∏—Å, —Ä–µ–∂–∏–º –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏

```
broker-service (–æ–¥–∏–Ω deployment)
    ‚îÇ
    ‚îú‚îÄ‚îÄ FakeBrokerAdapter      ‚Üê –¥–ª—è type=fake
    ‚îú‚îÄ‚îÄ SandboxBrokerAdapter   ‚Üê –¥–ª—è type=sandbox  
    ‚îî‚îÄ‚îÄ TinkoffBrokerAdapter   ‚Üê –¥–ª—è type=real
```

### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è order.create

```json
{
    "trace_id": "550e8400-e29b-41d4-a716-446655440000",
    "account_id": "acc-123",
    "account_type": "fake",
    "figi": "BBG004730N88",
    "direction": "buy",
    "order_type": "market",
    "quantity": 10,
    "price": null
}
```

### –í—ã–±–æ—Ä –∞–¥–∞–ø—Ç–µ—Ä–∞

```cpp
class OrderCommandHandler {
public:
    void handle(const OrderCreateMessage& msg) {
        // –í—ã–±–∏—Ä–∞–µ–º –∞–¥–∞–ø—Ç–µ—Ä –ø–æ —Ç–∏–ø—É –∞–∫–∫–∞—É–Ω—Ç–∞
        IBrokerGateway* gateway = selectGateway(msg.accountType);
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ä–¥–µ—Ä
        OrderResult result = gateway->placeOrder(msg.accountId, msg.toOrderRequest());
        
        // –ü—É–±–ª–∏–∫—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        publishOrderResult(msg.traceId, result);
    }
    
private:
    IBrokerGateway* selectGateway(AccountType type) {
        switch (type) {
            case AccountType::FAKE:
                return fakeBroker_.get();
            case AccountType::SANDBOX:
                return sandboxBroker_.get();
            case AccountType::REAL:
                return tinkoffBroker_.get();
        }
    }
};
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞

| –ê—Å–ø–µ–∫—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| –ü—Ä–æ—Å—Ç–æ—Ç–∞ | –û–¥–∏–Ω deployment, –æ–¥–Ω–∞ –∫–æ–¥–æ–≤–∞—è –±–∞–∑–∞ |
| –ì–∏–±–∫–æ—Å—Ç—å | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ |
| –ú–∏–≥—Ä–∞—Ü–∏—è | –õ–µ–≥–∫–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ routing –ø–æ –æ—á–µ—Ä–µ–¥—è–º –µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è |

### –ë—É–¥—É—â–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

–ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–æ–ª—è—Ü–∏—è –∏–ª–∏ —Ä–∞–∑–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:

```
RabbitMQ Exchange (topic)
    ‚îú‚îÄ‚îÄ order.create.fake    ‚Üí broker-service (replicas: 3)
    ‚îú‚îÄ‚îÄ order.create.sandbox ‚Üí broker-service (replicas: 1)
    ‚îî‚îÄ‚îÄ order.create.real    ‚Üí broker-service (replicas: 1)
```

Trading-service –±—É–¥–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ `order.create.{account_type}`.

---

## –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

### –°–∏—Å—Ç–µ–º–Ω—ã–π —Ç–æ–∫–µ–Ω

Broker-service –∏–º–µ–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω Tinkoff API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

```yaml
# config.yaml
broker:
  system_token: "${TINKOFF_SYSTEM_TOKEN}"  # Read-only —Ç–æ–∫–µ–Ω
  
  market_data:
    source: "tinkoff"  # –∏–ª–∏ "historical", "generated"
    cache_ttl_ms: 1000
```

### –†–µ–∂–∏–º—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è fake)

| –†–µ–∂–∏–º | –û–ø–∏—Å–∞–Ω–∏–µ | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|-------|----------|-------------------|
| `realtime` | –†–µ–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã —Å –±–∏—Ä–∂–∏ | –î–µ–º–æ-—Ç–æ—Ä–≥–æ–≤–ª—è |
| `historical` | –î–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –∑–∞ –ø—Ä–æ—à–ª—ã–π –ø–µ—Ä–∏–æ–¥ | –ë—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥ |
| `generated` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PriceSimulator | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, CI/CD |

–†–µ–∂–∏–º –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —á–µ—Ä–µ–∑ ENV:

```bash
MARKET_DATA_SOURCE=realtime   # –∏–ª–∏ historical, generated
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫

```
Tinkoff API  ‚îÄ‚îÄ‚ñ∫  QuoteCache (TTL 1 —Å–µ–∫)  ‚îÄ‚îÄ‚ñ∫  –í—Å–µ fake-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                        ‚ñ≤
                 –û–¥–∏–Ω WebSocket stream
```

Fake-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞, –Ω–µ —Å–æ–∑–¥–∞–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ Tinkoff API.

### –°–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

Broker-service –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞:

```json
{
    "supported_instruments": [
        "BBG004730N88",  // SBER
        "BBG004730RP0",  // GAZP
        "BBG004731032",  // LKOH
        "BBG006L8G4H1"   // YNDX
    ]
}
```

–ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:

```json
{
    "status": "rejected",
    "reason": "Instrument XXXX is not supported by the platform"
}
```

### Historical Data

–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î –∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

```sql
CREATE TABLE historical_quotes (
    id BIGSERIAL PRIMARY KEY,
    figi VARCHAR(20) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    open DECIMAL(18, 8),
    high DECIMAL(18, 8),
    low DECIMAL(18, 8),
    close DECIMAL(18, 8),
    volume BIGINT,
    
    UNIQUE(figi, timestamp)
);

CREATE INDEX idx_historical_quotes_figi_ts ON historical_quotes(figi, timestamp);
```

–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:
- –ò–∑ —Ñ–∞–π–ª–æ–≤ (CSV, JSON)
- –ß–µ—Ä–µ–∑ Tinkoff API (GetCandles)

–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∑–∞–≥—Ä—É–∂–∞–µ–º ~1000 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç–∏–∫–æ–≤ –≤ –ø–∞–º—è—Ç—å
- LRU-–∫—ç—à –¥–ª—è —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞–º–∏

### –§–∞–∫—Ç—ã –æ —Ç–æ–∫–µ–Ω–∞—Ö Tinkoff

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –°—Ä–æ–∫ –∂–∏–∑–Ω–∏ | 90 –¥–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |
| –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ | –ë–µ—Å—Å—Ä–æ—á–Ω–æ |
| API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏ | –ù–µ—Ç |
| –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–º —Ç–æ–∫–µ–Ω–µ | `code: 40003` |

### TokenKeepAliveService

–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–æ–≤:

```cpp
class TokenKeepAliveService {
public:
    // –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ (cron / scheduled task)
    void refreshAllTokens() {
        auto accounts = accountRepository_->getAccountsWithTokens();
        
        for (const auto& account : accounts) {
            if (account.status != AccountStatus::ACTIVE) {
                continue;
            }
            
            try {
                // GetAccounts() ‚Äî –ª—ë–≥–∫–∏–π –∑–∞–ø—Ä–æ—Å, –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω
                auto tinkoffAccounts = grpcClient_->getAccounts(account.token);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º last_used_at
                accountRepository_->updateLastUsed(account.id, now());
                
                log_->info("Token refreshed for account {}", account.id);
                
            } catch (const TinkoffException& e) {
                if (e.code() == 40003) {
                    // –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
                    accountRepository_->setStatus(
                        account.id, 
                        AccountStatus::TOKEN_INVALID
                    );
                    
                    // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    notificationService_->notify(
                        account.userId,
                        "–í–∞—à —Ç–æ–∫–µ–Ω Tinkoff –∏—Å—Ç—ë–∫. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –µ–≥–æ."
                    );
                }
            }
        }
    }
};
```

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ

| –ó–∞–¥–∞—á–∞ | –ò–Ω—Ç–µ—Ä–≤–∞–ª |
|--------|----------|
| Token keepalive | –†–∞–∑ –≤ —Å—É—Ç–∫–∏ |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö (< 7 –¥–Ω–µ–π) | –†–∞–∑ –≤ —Å—É—Ç–∫–∏ |

### –•—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤

–¢–æ–∫–µ–Ω—ã —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î:

```cpp
std::string encryptToken(const std::string& token) {
    // AES-256-GCM
    return aes256_encrypt(token, getEncryptionKey());
}
```

–ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:
- Development: –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
- Production: –∏–∑ Kubernetes Secrets –∏–ª–∏ HashiCorp Vault

---

## –°—Ç–∞—Ç—É—Å—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤

### Enum

```cpp
enum class AccountStatus {
    ACTIVE,         // –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç
    TOKEN_INVALID,  // –¢–æ–∫–µ–Ω –∏—Å—Ç—ë–∫ –∏–ª–∏ –æ—Ç–æ–∑–≤–∞–Ω
    SUSPENDED       // –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
};
```

### –ü–µ—Ä–µ—Ö–æ–¥—ã

```
ACTIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ TOKEN_INVALID
   ‚îÇ                 ‚îÇ
   ‚îÇ                 ‚îÇ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–∏–ª —Ç–æ–∫–µ–Ω)
   ‚îÇ                 ‚ñº
   ‚îÇ           ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ ACTIVE
   ‚îÇ
   ‚ñº
SUSPENDED ‚îÄ‚îÄ‚îÄ‚ñ∫ ACTIVE (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª)
```

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–∞—Ö

| –°—Ç–∞—Ç—É—Å | –¢–æ—Ä–≥–æ–≤–ª—è | UI | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|----------|----|---------| 
| ACTIVE | –†–∞–∑—Ä–µ—à–µ–Ω–∞ | –ù–æ—Ä–º–∞–ª—å–Ω—ã–π | ‚Äî |
| TOKEN_INVALID | –ó–∞–ø—Ä–µ—â–µ–Ω–∞ | –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ | –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω |
| SUSPENDED | –ó–∞–ø—Ä–µ—â–µ–Ω–∞ | –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É | –°–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π |

---

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### SimulationClock (–Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ–º —Å–µ–π—á–∞—Å)

–î–ª—è –±—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥–∞ —Å —É—Å–∫–æ—Ä–µ–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏:

```cpp
class ISimulationClock {
    virtual Timestamp now() const = 0;
    virtual void setSpeed(double multiplier) = 0;  // 1x, 10x, 100x
};

class RealClock : public ISimulationClock { ... };
class ReplayClock : public ISimulationClock { ... };
```

–ü–æ–∑–≤–æ–ª–∏—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é 100x.

### Graceful Degradation (—É–ø–æ–º—è–Ω—É—Ç—å)

–ï—Å–ª–∏ Tinkoff API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è fake-—Ä–µ–∂–∏–º–∞:

```
Realtime data (Tinkoff) 
        ‚Üì (–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
Generated data (PriceSimulator)
        +
–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

### –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏

–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:
- `order.create.fake` ‚Üí 3 consumers
- `order.create.real` ‚Üí 1 consumer —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

| –î–æ–∫—É–º–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| [TODO_PRODUCTION.md](./TODO_PRODUCTION.md) | –û–±—â–∏–π roadmap |
| [ORDER_PROCESSOR.md](./ORDER_PROCESSOR.md) | –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ FakeBroker |
| [TINKOFF_INTEGRATION.md](./TINKOFF_INTEGRATION.md) | –î–µ—Ç–∞–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Tinkoff API |
| [my_production_plan_v1.md](./my_production_plan_v1.md) | –ò—Å—Ö–æ–¥–Ω—ã–µ –∏–¥–µ–∏ |

---

## Changelog

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞ | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|--------|------|-----------|
| 2.0 | 2025-01-12 | –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã —Ä–µ—à–µ–Ω–∏—è: trace_id, —Ç–∏–ø—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±—Ä–æ–∫–µ—Ä–∞ |
| 1.0 | 2025-01-07 | –ù–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (TODO_PRODUCTION.md) |

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω: 2025-01-12*
