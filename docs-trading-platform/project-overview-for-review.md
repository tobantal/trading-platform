# 📊 Trading Platform — Обзор проекта

## Курс: Microservice Architecture (OTUS)
## Студент: Тоболкин Антон
## Дата: 16 декабря 2025

---

# 1. Общее описание

## Что это?

**Платформа для алгоритмической торговли** на Московской бирже (MOEX) через Tinkoff Invest API.

Система позволяет:
- Просматривать портфель и котировки
- Размещать ордера на покупку/продажу акций
- Запускать автоматические торговые стратегии (SMA Crossover)

## Почему этот проект?

| Причина | Описание |
|---------|----------|
| **Практическая ценность** | Планируется использовать для реальной торговли после курса |
| **Сложность домена** | Биржевая торговля — хороший пример для микросервисной архитектуры |
| **Переиспользование кода** | Интеграция наработок из других курсов OTUS |

---

# 2. Архитектура

## Гексагональная архитектура (Ports & Adapters)

```
┌─────────────────────────────────────────────────────────────┐
│                      PRIMARY ADAPTERS                       │
│              (REST Controllers, WebSocket)                  │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      INPUT PORTS                            │
│    IAuthService, IMarketService, IOrderService,            │
│    IPortfolioService, IStrategyService                      │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      DOMAIN CORE                            │
│         Entities: Order, Quote, Position, Strategy          │
│         Business Logic: SMA Crossover Algorithm             │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      OUTPUT PORTS                           │
│    IBrokerGateway, IOrderRepository, IJwtProvider,         │
│    IEventBus, ICache                                        │
└─────────────────────────┬───────────────────────────────────┘
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    SECONDARY ADAPTERS                       │
│    PostgreSQL, FakeTinkoff, fake-jwt-server, LRU Cache     │
└─────────────────────────────────────────────────────────────┘
```

## Ключевые принципы

1. **Dependency Inversion** — бизнес-логика не зависит от инфраструктуры
2. **Легко тестировать** — Fake адаптеры для unit-тестов без внешних зависимостей
3. **Легко масштабировать** — тот же код работает как монолит или микросервисы

---

# 3. Этапы разработки

## Четыре этапа развития проекта

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ЭТАПЫ РАЗВИТИЯ ПРОЕКТА                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │ HELLOWORLD  │───▶│    MVP      │───▶│  EDUCATION  │───▶│ PRODUCTION  │  │
│  │  (done ✅)  │    │ (в работе)  │    │  (план)     │    │  (future)   │  │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘  │
│        │                  │                  │                  │          │
│        ▼                  ▼                  ▼                  ▼          │
│   Инфраструктура     Бизнес-логика     Микросервисы      Реальный API     │
│   Docker Compose     Fake Tinkoff      Service Split     Tinkoff gRPC     │
│   FetchContent       PostgreSQL        RabbitMQ          Kubernetes       │
│   Prometheus         JWT Auth          API Gateway       HA/DR            │
│                      SMA Strategy      ZITADEL                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Этап 1: HelloWorld ✅ (выполнен)

**Цель:** Проверить инфраструктуру и интеграцию библиотек.

**Результат:**
- Docker Compose работает (backend, nginx, PostgreSQL, Prometheus)
- Библиотеки cpp-http-server и cpp-cache подключены через FetchContent
- REST endpoints: `/api/v1/health`, `/metrics`, `/echo`

### Этап 2: MVP (текущий, дедлайн 21.12)

**Цель:** Рабочий продукт с основной функциональностью.

**Что реализуем:**
- Гексагональная архитектура (Ports & Adapters)
- JWT авторизация через fake-jwt-server
- SimpleBrokerGatewayAdapter (эмуляция брокера без реального API)
- Торговля акциями (5 инструментов: SBER, LKOH, GAZP, VTBR, YNDX)
- Одна стратегия: SMA Crossover
- In-memory Event Bus
- Простой Web UI (HTML + JS + Bootstrap)

**Что НЕ реализуем:**
- Реальный Tinkoff API (gRPC + протобуфы)
- Облигации и фьючерсы
- WebSocket real-time
- RabbitMQ

### Этап 3: Education (дедлайн 28.12)

**Цель:** Демонстрация микросервисных паттернов.

**Что добавим:**
- Разделение на 3 микросервиса (Market, Trading, Portfolio)
- API Gateway
- RabbitMQ вместо in-memory Event Bus
- ZITADEL/loginsrv для полноценной авторизации
- Distributed Tracing (X-Trace-ID)

### Этап 4: Production (после курса)

**Цель:** Готовность к реальной торговле.

**Что добавим:**
- Реальный Tinkoff Invest API (gRPC)
- Kubernetes deployment
- Собственный Auth Service
- Бэктестинг стратегий
- Дополнительные стратегии (RSI, MACD)

---

# 4. Технологический стек

## Основные технологии

| Компонент | Технология | Примечание |
|-----------|------------|------------|
| Язык | C++17 | Современный стандарт |
| HTTP Server | Boost.Beast + Boost.Asio | Собственная библиотека |
| DI Container | Boost.DI | Dependency Injection |
| Cache | Custom LRU | Из курса "Алгоритмы" |
| Database | PostgreSQL 15 | ACID транзакции |
| Auth (MVP) | fake-jwt-server | Быстрое подключение |
| Monitoring | Prometheus | Метрики |
| Containers | Docker Compose | Оркестрация |

## Переиспользование кода из других курсов OTUS

| Курс | Что используем |
|------|----------------|
| "Архитектура и шаблоны проектирования" | HTTP Server (Boost.Beast) |
| "Алгоритмы и структуры данных" | LRU Cache |
| "Архитектура и шаблоны проектирования" | PostgreSQL utilities, ThreadSafeMap |

---

# 5. Bounded Contexts (DDD)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           BOUNDED CONTEXTS                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────┐   ┌───────────────┐   ┌───────────────┐                │
│   │   IDENTITY    │   │  MARKET DATA  │   │   TRADING     │                │
│   │               │   │               │   │               │                │
│   │ • User        │   │ • Quote       │   │ • Order       │                │
│   │ • Account     │   │ • Instrument  │   │ • Position    │                │
│   │ • JWT Token   │   │ • Price       │   │ • Portfolio   │                │
│   └───────────────┘   └───────────────┘   └───────────────┘                │
│                                                                             │
│   ┌───────────────┐   ┌───────────────┐                                    │
│   │   STRATEGY    │   │ NOTIFICATION  │                                    │
│   │               │   │   (future)    │                                    │
│   │ • Strategy    │   │               │                                    │
│   │ • Signal      │   │ • Alert       │                                    │
│   │ • SMA Config  │   │ • Email       │                                    │
│   └───────────────┘   └───────────────┘                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**MVP:** Все контексты в одном монолите.  
**Education:** Market, Trading, Strategy — отдельные сервисы.

---

# 6. Микросервисные паттерны

## Используемые паттерны

| Паттерн | MVP | Education | Описание |
|---------|:---:|:---------:|----------|
| **Hexagonal Architecture** | ✅ | ✅ | Ports & Adapters |
| **API Gateway** | — | ✅ | Single entry point |
| **Database per Service** | — | ✅ | Изоляция данных |
| **Event-Driven** | ✅ in-memory | ✅ RabbitMQ | Слабая связанность |
| **Circuit Breaker** | ✅ | ✅ | Отказоустойчивость |
| **Distributed Tracing** | — | ✅ | X-Trace-ID |
| **Service Discovery** | — | ✅ | Docker DNS |

---

# 7. Пользовательские сценарии (MVP)

## Основные use cases

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         USER STORIES (MVP)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  🔐 US-001: Логин и получение JWT токена                                   │
│     POST /api/v1/auth/login → { access_token, expires_in }                 │
│                                                                             │
│  💼 US-002: Просмотр портфеля                                               │
│     GET /api/v1/portfolio → { positions, cash, totalValue }                │
│                                                                             │
│  📊 US-003: Получение котировок                                             │
│     GET /api/v1/quotes?figis=SBER,LKOH → { quotes[] }                      │
│                                                                             │
│  💱 US-004: Размещение ордера                                               │
│     POST /api/v1/orders → { orderId, status }                              │
│                                                                             │
│  🤖 US-005: Создание SMA стратегии                                          │
│     POST /api/v1/strategies → { strategyId, status }                       │
│                                                                             │
│  ▶️ US-006: Запуск/остановка стратегии                                      │
│     POST /api/v1/strategies/{id}/start → { status: RUNNING }               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 8. Архитектура развёртывания

## MVP: Docker Compose

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DOCKER COMPOSE (MVP)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Browser ──▶ Nginx (:3001) ──▶ Backend (:8080) ──▶ PostgreSQL (:5432)     │
│                  │                   │                                      │
│                  │                   ├──▶ fake-jwt-server (:8008)          │
│                  │                   │                                      │
│                  └──▶ Prometheus (:9090)                                   │
│                                                                             │
│   Контейнеры:                                                               │
│   • trading-backend      - C++ приложение                                  │
│   • trading-nginx        - Reverse proxy + статика                         │
│   • trading-postgres     - База данных                                     │
│   • trading-prometheus   - Мониторинг                                      │
│   • trading-fake-jwt     - JWT авторизация                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Education: Микросервисы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DOCKER COMPOSE (EDUCATION)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Browser ──▶ API Gateway ──┬──▶ Market Service ──▶ PostgreSQL (market)    │
│                             │                                               │
│                             ├──▶ Trading Service ──▶ PostgreSQL (trading)  │
│                             │                                               │
│                             └──▶ Portfolio Service ──▶ PostgreSQL (portfolio)│
│                                                                             │
│   Все сервисы ◀──▶ RabbitMQ ◀──▶ Все сервисы                               │
│                                                                             │
│   Auth: ZITADEL                                                             │
│   Monitoring: Prometheus + Grafana                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 9. Критерии приёмки

## Функциональные критерии (MVP)

| # | Критерий | Приоритет |
|---|----------|:---------:|
| 1 | Логин и получение JWT | P0 |
| 2 | Просмотр портфеля | P0 |
| 3 | Получение котировок | P0 |
| 4 | Создание ордера | P0 |
| 5 | Создание и запуск SMA стратегии | P1 |
| 6 | Web UI работает | P1 |

## Архитектурные критерии

| # | Критерий |
|---|----------|
| 1 | Гексагональная архитектура (Ports & Adapters) |
| 2 | DI через Boost.DI |
| 3 | PostgreSQL с миграциями |
| 4 | Prometheus метрики |
| 5 | Docker Compose запускается одной командой |
| 6 | SimpleBrokerGatewayAdapter для тестирования |

## Демонстрация

```bash
# Запуск
docker compose up -d

# Проверка
curl http://localhost:8080/api/v1/health
curl -X POST http://localhost:8080/api/v1/auth/login -d '{"username":"trader"}'
curl -H "Authorization: Bearer <token>" http://localhost:8080/api/v1/portfolio

# Web UI
open http://localhost:3001
```

---

# 10. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|:-----------:|:-------:|-----------|
| Не успеваю MVP к 21.12 | Средняя | Высокое | Приоритизация P0 задач, отказ от UI |
| Сложности с FetchContent | Низкая | Среднее | Библиотеки уже работают в HelloWorld |
| PostgreSQL интеграция | Низкая | Среднее | Код из курса "Паттерны" |

---

*Документ подготовлен для согласования проекта*  
*Версия: 1.0*  
*Дата: 16 декабря 2025*
