# ะะฝัะตะณัะฐัะธั ั Tinkoff Invest API

> **ะกัะฐััั:** ะัะพัะฐะฑะพัะบะฐ ะฐััะธัะตะบัััั  
> **ะัะธะพัะธัะตั:** P1 (ะฟะพัะปะต MVP)  
> **ะัะตะฝะบะฐ:** 20-30 ัะฐัะพะฒ

---

## ๐ ะกะพะดะตัะถะฐะฝะธะต

1. [ะะพะฝัะตะบัั ะธ ัะตะปะธ](#ะบะพะฝัะตะบัั-ะธ-ัะตะปะธ)
2. [ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ broker-service](#ัะตะบััะฐั-ะฐััะธัะตะบัััะฐ-broker-service)
3. [Tinkoff Invest API โ ะบะปััะตะฒัะต ัะฐะบัั](#tinkoff-invest-api--ะบะปััะตะฒัะต-ัะฐะบัั)
4. [ะััะธัะตะบัััะฐ ะธะฝัะตะณัะฐัะธะธ](#ะฐััะธัะตะบัััะฐ-ะธะฝัะตะณัะฐัะธะธ)
5. [ะะฐะฟะฟะธะฝะณ ัััะฝะพััะตะน](#ะผะฐะฟะฟะธะฝะณ-ัััะฝะพััะตะน)
6. [ะัะพะฑะปะตะผะฐ ะดัะฑะปะธัะพะฒะฐะฝะธั ัะพะฑััะธะน](#ะฟัะพะฑะปะตะผะฐ-ะดัะฑะปะธัะพะฒะฐะฝะธั-ัะพะฑััะธะน)
7. [TradesStream โ ะฟะพะดะฟะธัะบะฐ ะฝะฐ ะธัะฟะพะปะฝะตะฝะธั](#tradesstream--ะฟะพะดะฟะธัะบะฐ-ะฝะฐ-ะธัะฟะพะปะฝะตะฝะธั)
8. [ะกะธะฝััะพะฝะธะทะฐัะธั ะธ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต](#ัะธะฝััะพะฝะธะทะฐัะธั-ะธ-ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต)
9. [ะะตัะฐะบัะพัะธะฝะณ FakeBroker (ัะตั. ะดะพะปะณ)](#ัะตัะฐะบัะพัะธะฝะณ-fakebroker-ัะตั-ะดะพะปะณ)
10. [ะัะบััััะต ะฒะพะฟัะพัั](#ะพัะบััััะต-ะฒะพะฟัะพัั)
11. [ะะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ](#ะฟะปะฐะฝ-ัะตะฐะปะธะทะฐัะธะธ)

---

## ะะพะฝัะตะบัั ะธ ัะตะปะธ

### ะะฐัะตะผ ะฝัะถะฝะฐ ะธะฝัะตะณัะฐัะธั

ะขะตะบััะฐั ัะธััะตะผะฐ ะธัะฟะพะปัะทัะตั FakeBroker ะดะปั ัะธะผัะปััะธะธ ะฑะธัะถะธ. ะะปั ัะตะฐะปัะฝะพะน ัะพัะณะพะฒะปะธ ะฝัะถะฝะพ ะฟะพะดะบะปััะธัั Tinkoff Invest API.

### ะฆะตะปะธ

1. **ะะธะฝะธะผะฐะปัะฝัะต ะธะทะผะตะฝะตะฝะธั** โ ะธัะฟะพะปัะทะพะฒะฐัั ัััะตััะฒัััะธะน ะฟะพัั IBrokerGateway
2. **ะะตัะตะบะปััะตะฝะธะต ัะตัะตะท DI** โ FakeBroker ะดะปั ัะตััะพะฒ, TinkoffBroker ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ
3. **ะกะพััะฐะฝะตะฝะธะต event-driven ะฐััะธัะตะบัััั** โ ัะต ะถะต ัะพะฑััะธั (order.created, order.filled, etc.)

### ะะณัะฐะฝะธัะตะฝะธั

- Tinkoff API ะธะผะตะตั ะปะธะผะธัั (50 req/sec ัะตะบะพะผะตะฝะดะฐัะธั, 1000 req/min hard limit)
- ะะตะปัะทั ะฟะพะดะฟะธััะฒะฐัััั ะฝะฐ ะบะฐะถะดัะน ะพัะดะตั ะพัะดะตะปัะฝะพ
- ะัะถะตะฝ ะผะฐะฟะฟะธะฝะณ ะฝะฐัะธั ัััะฝะพััะตะน ั ัััะฝะพัััะผะธ Tinkoff

---

## ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ broker-service

### ะฆะตะฟะพัะบะฐ ะฒัะทะพะฒะพะฒ

```
RabbitMQ (order.create)
       โ
       โผ
OrderCommandHandler
       โ
       โ 1. ะะฐะปะธะดะฐัะธั
       โ 2. publishOrderCreated(PENDING)
       โ 3. brokerGateway_->placeOrder()
       โ 4. publishOrderFilled/Rejected
       โ
       โผ
IBrokerGateway (ะฟะพัั)
       โ
       โผ
FakeBrokerAdapter (ะฐะดะฐะฟัะตั)
       โ
       โผ
EnhancedFakeBroker
       โ
       โผ
OrderProcessor
       โ
       โผ
OrderResult {status: FILLED/PENDING/REJECTED}
```

### ะะปััะตะฒัะต ะธะฝัะตััะตะนัั

```cpp
class IBrokerGateway {
    virtual OrderResult placeOrder(const std::string& accountId, const OrderRequest& request) = 0;
    virtual bool cancelOrder(const std::string& accountId, const std::string& orderId) = 0;
    virtual std::optional<Quote> getQuote(const std::string& figi) = 0;
    virtual Portfolio getPortfolio(const std::string& accountId) = 0;
    // ...
};
```

### ะกะพะฑััะธั

| ะกะพะฑััะธะต | ะะพะณะดะฐ ะฟัะฑะปะธะบัะตััั |
|---------|-------------------|
| order.created | ะกัะฐะทั ะฟะพัะปะต ะฒะฐะปะธะดะฐัะธะธ (ััะฐััั PENDING) |
| order.filled | ะะพะณะดะฐ ะพัะดะตั ะธัะฟะพะปะฝะตะฝ |
| order.partially_filled | ะงะฐััะธัะฝะพะต ะธัะฟะพะปะฝะตะฝะธะต |
| order.rejected | ะัะดะตั ะพัะบะปะพะฝัะฝ |
| order.cancelled | ะัะดะตั ะพัะผะตะฝัะฝ |

---

## Tinkoff Invest API โ ะบะปััะตะฒัะต ัะฐะบัั

### ะััะพัะฝะธะบ

- ะะพะบัะผะตะฝัะฐัะธั: https://tinkoff.github.io/investAPI/
- GitHub: https://github.com/Tinkoff/investAPI
- ะัะพัะพะบะพะป: gRPC

### Endpoints

| ะะพะฝััั | URL |
|--------|-----|
| Production | invest-public-api.tinkoff.ru:443 |
| Sandbox | sandbox-invest-public-api.tinkoff.ru:443 |

### ะะธะผะธัั

| ะะฐัะฐะผะตัั | ะะฝะฐัะตะฝะธะต |
|----------|----------|
| ะะตะบะพะผะตะฝะดะฐัะธั | 50 req/sec ะฝะฐ IP |
| Hard limit | 1000 req/min ะฝะฐ IP |
| Stream ัะพะตะดะธะฝะตะฝะธั | ~4 ะฝะฐ MarketDataStream |
| ะัะตะนะดั | ะงะตะผ ะฑะพะปััะต ัะพัะณัะตัั, ัะตะผ ะฑะพะปััะต ะปะธะผะธัั |

> **ะะฐะถะฝะพ:** ะัะธ ะฟัะตะฒััะตะฝะธะธ ะปะธะผะธัะฐ โ ะพัะธะฑะบะฐ RESOURCE_EXHAUSTED (80001)

### ะะะะขะะงะะกะะ ะะะะะ: order_id โ ััะพ ะะะ ะะะะะซะฅ ะะะะงะะะะฏ!

```
postOrder(request):
  request.order_id  โ ะะซ ะณะตะฝะตัะธััะตะผ (idempotency key)
  
postOrder() returns:
  response.order_id โ Tinkoff ะฒะพะทะฒัะฐัะฐะตั (ะฑะธัะถะตะฒะพะน ะธะดะตะฝัะธัะธะบะฐัะพั)
  response.order_request_id โ ะะฐั idempotency key (echo back)
```

**ะญัะพ ะพะทะฝะฐัะฐะตั:**
- ะั ะฟะตัะตะดะฐัะผ `order_id` ะบะฐะบ ะบะปัั ะธะดะตะผะฟะพัะตะฝัะฝะพััะธ (ะฝะฐั ord-uuid)
- Tinkoff ะฒะพะทะฒัะฐัะฐะตั ะะะฃะะะ `order_id` โ ะฑะธัะถะตะฒะพะน ะธะดะตะฝัะธัะธะบะฐัะพั
- ะะปั ะผะฐะฟะฟะธะฝะณะฐ ะฝัะถะฝะพ ััะฐะฝะธัั ะะะ

### ะะตัะพะด postOrder

```protobuf
message PostOrderRequest {
  string account_id = 1;      // ID ััััะฐ ะฒ Tinkoff
  string instrument_id = 2;   // FIGI ะธะปะธ UID
  int64 quantity = 3;         // ะะพะปะธัะตััะฒะพ ะปะพัะพะฒ
  Quotation price = 4;        // ะฆะตะฝะฐ (ะดะปั LIMIT)
  OrderDirection direction = 5;
  OrderType order_type = 6;
  string order_id = 7;        // ะะฐั idempotency key!
}

message PostOrderResponse {
  string order_id = 1;        // ะะธัะถะตะฒะพะน ID (ะะะฃะะะ!)
  ExecutionReportStatus execution_report_status = 2;
  MoneyValue executed_order_price = 3;
  int64 lots_executed = 4;
  string order_request_id = 5;  // ะะฐั idempotency key (echo)
  // ...
}
```

### ExecutionReportStatus (ััะฐัััั)

| ะกัะฐััั | ะะฟะธัะฐะฝะธะต |
|--------|----------|
| EXECUTION_REPORT_STATUS_FILL | ะัะฟะพะปะฝะตะฝะฐ ะฟะพะปะฝะพัััั |
| EXECUTION_REPORT_STATUS_PARTIALLYFILL | ะงะฐััะธัะฝะพ ะธัะฟะพะปะฝะตะฝะฐ |
| EXECUTION_REPORT_STATUS_NEW | ะะพะฒะฐั (ะฟัะธะฝััะฐ ะฑะธัะถะตะน) |
| EXECUTION_REPORT_STATUS_REJECTED | ะัะบะปะพะฝะตะฝะฐ |
| EXECUTION_REPORT_STATUS_CANCELLED | ะัะผะตะฝะตะฝะฐ |

### TradesStream โ server-side stream

> "ะ ะดะฐะฝะฝัะน ัััะธะผ ะฟะพะฟะฐะดะฐัั ะฒัะต ัะพะฒะตัััะฝะฝัะต ัะดะตะปะบะธ ะฟะพ **ะฒัะตะผ ััะตัะฐะผ ะฟะพะปัะทะพะฒะฐัะตะปั**"

**ะะปััะตะฒัะต ะพัะพะฑะตะฝะฝะพััะธ:**
- ะะดะธะฝ stream ะฝะฐ ัะพะบะตะฝ โ ะฒัะต ะฐะบะบะฐัะฝัั ััะพะณะพ ัะพะบะตะฝะฐ
- ะะ ะฟะพะดะฟะธัะบะฐ ะฝะฐ ะพัะดะตะปัะฝัะน ะพัะดะตั
- ะะพะปััะฐะตะผ ัะพะฑััะธั ะฟะพ ัะฐะบัั ะธัะฟะพะปะฝะตะฝะธั
- Ping-ะฟะฐะบะตัั ะดะปั ะฟะพะดะดะตัะถะฐะฝะธั ัะพะตะดะธะฝะตะฝะธั

```protobuf
message TradesStreamRequest {
  repeated string accounts = 1;  // ะกะฟะธัะพะบ account_id ะดะปั ัะธะปัััะฐัะธะธ
}

message TradesStreamResponse {
  oneof payload {
    OrderTrades order_trades = 1;
    Ping ping = 2;
  }
}

message OrderTrades {
  string order_id = 1;      // ะะธัะถะตะฒะพะน ID
  string account_id = 2;
  string figi = 3;
  repeated OrderTrade trades = 4;  // ะกะฟะธัะพะบ ัะดะตะปะพะบ
  // ...
}
```

---

## ะััะธัะตะบัััะฐ ะธะฝัะตะณัะฐัะธะธ

### ะะฑัะฐั ััะตะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       broker-service                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ   OrderCommandHandler                                                       โ
โ         โ                                                                   โ
โ         โ uses                                                              โ
โ         โผ                                                                   โ
โ   IBrokerGateway (ะฟะพัั)                                                     โ
โ         โ                                                                   โ
โ         โโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ              โ
โ         โ                         โ                         โ              โ
โ         โผ                         โผ                         โผ              โ
โ   FakeBrokerAdapter        TinkoffBrokerAdapter      (ะฑัะดััะธะต ะฑัะพะบะตัั)     โ
โ   (ัะตััั/ะดะตะผะพ)             (ะฟัะพะดะฐะบัะตะฝ)                                     โ
โ         โ                         โ                                        โ
โ         โผ                         โโโโโโโโโโโโโโโโโโโโ                     โ
โ   OrderProcessor                  โ                  โ                     โ
โ   BackgroundTicker                โผ                  โผ                     โ
โ                            gRPC Client         StreamManager               โ
โ                            (postOrder,         (TradesStream)              โ
โ                             cancelOrder)                                   โ
โ                                   โ                  โ                     โ
โ                                   โ                  โ                     โ
โ                                   โผ                  โผ                     โ
โ                            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ                            โ     order_mappings (ะะ)     โ                 โ
โ                            โ     account_mappings (ะะ)   โ                 โ
โ                            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                 โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                    โ
                                    โผ
                         โโโโโโโโโโโโโโโโโโโโโโโ
                         โ  Tinkoff Invest API โ
                         โ  (gRPC)             โ
                         โโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะผะฟะพะฝะตะฝัั TinkoffBrokerAdapter

```
TinkoffBrokerAdapter
โโโ AccountRegistry        โ ัะฟัะฐะฒะปะตะฝะธะต ะฐะบะบะฐัะฝัะฐะผะธ ะธ ัะพะบะตะฝะฐะผะธ
โโโ OrderTracker           โ ะพััะปะตะถะธะฒะฐะฝะธะต ััะฐัััะพะฒ ะพัะดะตัะพะฒ (order_mappings)
โโโ TinkoffGrpcClient      โ gRPC ะฒัะทะพะฒั (postOrder, cancelOrder, getQuote)
โโโ StreamManager          โ ัะฟัะฐะฒะปะตะฝะธะต TradesStream ัะพะตะดะธะฝะตะฝะธัะผะธ
```

### ะะตัะตะบะปััะตะฝะธะต ัะตัะตะท DI

```cpp
// config.yaml
broker:
  type: "tinkoff"  # ะธะปะธ "fake"
  tinkoff:
    use_sandbox: true
    
// main.cpp
std::shared_ptr<IBrokerGateway> brokerGateway;

if (config.broker.type == "tinkoff") {
    brokerGateway = std::make_shared<TinkoffBrokerAdapter>(
        config.broker.tinkoff,
        eventPublisher
    );
} else {
    brokerGateway = std::make_shared<FakeBrokerAdapter>(...);
}

auto handler = std::make_shared<OrderCommandHandler>(
    eventConsumer, eventPublisher, brokerGateway
);
```

---

## ะะฐะฟะฟะธะฝะณ ัััะฝะพััะตะน

### ะัะพะฑะปะตะผะฐ

ะะฐัะฐ ัะธััะตะผะฐ ะธ Tinkoff ะธัะฟะพะปัะทััั ัะฐะทะฝัะต ะธะดะตะฝัะธัะธะบะฐัะพัั:

| ะกััะฝะพััั | ะะฐัะฐ ัะธััะตะผะฐ | Tinkoff |
|----------|--------------|---------|
| Account | our_account_id (ะธะท auth-service) | tinkoff_account_id |
| Order | our_order_id (ord-uuid) | tinkoff_order_id (ะฑะธัะถะตะฒะพะน) |
| Instrument | figi | figi (ัะพะฒะฟะฐะดะฐะตั!) |

### ะขะฐะฑะปะธัะฐ: account_mappings

```sql
CREATE TABLE account_mappings (
    id SERIAL PRIMARY KEY,
    
    -- ะะฐั ID (ะธะท auth-service)
    our_account_id VARCHAR(64) UNIQUE NOT NULL,
    
    -- ID ะฒ Tinkoff (ะฟะพะปััะฐะตะผ ัะตัะตะท GetAccounts ะธะปะธ ะพั ะฟะพะปัะทะพะฒะฐัะตะปั)
    tinkoff_account_id VARCHAR(64) NOT NULL,
    
    -- ะขะพะบะตะฝ ะดะพัััะฟะฐ (ะะะจะะคะะะะะะะซะ!)
    tinkoff_token_encrypted TEXT NOT NULL,
    
    -- ะะฐัััะพะนะบะธ
    is_sandbox BOOLEAN DEFAULT true,
    is_active BOOLEAN DEFAULT true,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- ะะฝะดะตะบัั
    UNIQUE(tinkoff_account_id)
);

CREATE INDEX idx_account_mappings_active ON account_mappings(is_active);
```

### ะขะฐะฑะปะธัะฐ: order_mappings

```sql
CREATE TABLE order_mappings (
    id SERIAL PRIMARY KEY,
    
    -- ะะฐั ID (idempotency key, ะผั ะณะตะฝะตัะธััะตะผ)
    our_order_id VARCHAR(64) UNIQUE NOT NULL,
    
    -- ะะธัะถะตะฒะพะน ID (Tinkoff ะฒะพะทะฒัะฐัะฐะตั ะฒ response.order_id)
    -- NULL ะดะพ ะฟะพะปััะตะฝะธั ะพัะฒะตัะฐ ะพั Tinkoff
    tinkoff_order_id VARCHAR(64),
    
    -- ะกะฒัะทั ั ะฐะบะบะฐัะฝัะพะผ
    our_account_id VARCHAR(64) NOT NULL,
    
    -- ะะฐัะฐะผะตััั ะพัะดะตัะฐ
    figi VARCHAR(32) NOT NULL,
    direction VARCHAR(8) NOT NULL,        -- BUY, SELL
    order_type VARCHAR(8) NOT NULL,       -- MARKET, LIMIT
    quantity INT NOT NULL,
    price DECIMAL(18,8),                  -- NULL ะดะปั MARKET
    
    -- ะกัะฐััั ะธ ัะตะทัะปััะฐั
    status VARCHAR(32) NOT NULL,          -- PENDING, FILLED, PARTIALLY_FILLED, REJECTED, CANCELLED
    executed_quantity INT DEFAULT 0,
    executed_price DECIMAL(18,8),
    reject_reason TEXT,
    
    -- Timestamps
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    filled_at TIMESTAMP,
    
    -- Foreign keys
    CONSTRAINT fk_account FOREIGN KEY (our_account_id) 
        REFERENCES account_mappings(our_account_id),
        
    -- ะะฝะดะตะบัั
    CONSTRAINT idx_order_mappings_tinkoff_id UNIQUE(tinkoff_order_id)
);

CREATE INDEX idx_order_mappings_status ON order_mappings(status);
CREATE INDEX idx_order_mappings_account ON order_mappings(our_account_id);
CREATE INDEX idx_order_mappings_pending ON order_mappings(status) WHERE status = 'PENDING';
```

### ะะพัะตะผั ะฝัะถะฝั ะพะฑะต ัะฐะฑะปะธัั?

**account_mappings:**
- ะะฐะฟะฟะธะฝะณ ะฝะฐัะธั ะฐะบะบะฐัะฝัะพะฒ ะฝะฐ Tinkoff ะฐะบะบะฐัะฝัั
- ะฅัะฐะฝะตะฝะธะต ัะพะบะตะฝะพะฒ (ะทะฐัะธััะพะฒะฐะฝะฝัั)
- ะะดะธะฝ ะฟะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ะธะผะตัั ะฝะตัะบะพะปัะบะพ ะฐะบะบะฐัะฝัะพะฒ ะฒ Tinkoff

**order_mappings:**
- Idempotent ะพะฑัะฐะฑะพัะบะฐ (ะทะฐัะธัะฐ ะพั ะดัะฑะปะตะน)
- ะะฐะฟะฟะธะฝะณ our_order_id โ tinkoff_order_id
- ะััะปะตะถะธะฒะฐะฝะธะต ััะฐัััะฐ ะดะปั ัะธะฝััะพะฝะธะทะฐัะธะธ ะฟะพัะปะต ัะตััะฐััะฐ
- ะััะพัะธั ะพัะดะตัะพะฒ

---

## ะัะพะฑะปะตะผะฐ ะดัะฑะปะธัะพะฒะฐะฝะธั ัะพะฑััะธะน

### ะกัะตะฝะฐัะธะน

```
1. OrderCommandHandler ะฟะพะปััะฐะตั order.create
2. ะัะทัะฒะฐะตั TinkoffBrokerAdapter.placeOrder()
3. TinkoffBrokerAdapter ะฒัะทัะฒะฐะตั gRPC postOrder()
4. Tinkoff ะฒะพะทะฒัะฐัะฐะตั PostOrderResponse ั:
   - execution_report_status = FILL (ะดะปั MARKET โ ัะฐััะพ ััะฐะทั ะธัะฟะพะปะฝะตะฝ!)
   - order_id = "ะฑะธัะถะตะฒะพะน-id-123"
5. ะั ะฒะพะทะฒัะฐัะฐะตะผ OrderResult{status: FILLED}
6. OrderCommandHandler ะฟัะฑะปะธะบัะตั order.filled

... ะะะะะะะะะฌะะ ...

7. StreamManager ะฟะพะปััะฐะตั ัะพะฑััะธะต ะธะท TradesStream:
   - order_id = "ะฑะธัะถะตะฒะพะน-id-123"
   - ะขะต ะถะต ะดะฐะฝะฝัะต ะพะฑ ะธัะฟะพะปะฝะตะฝะธะธ
8. StreamManager ะฟัะฑะปะธะบัะตั order.filled ะะขะะะะ ะะะ???
```

**ะัะพะฑะปะตะผะฐ:** ะะฒะฐ ัะพะฑััะธั order.filled ะดะปั ะพะดะฝะพะณะพ ะพัะดะตัะฐ.

### ะะฐัะธะฐะฝัั ัะตัะตะฝะธั

#### ะะฐัะธะฐะฝั A: "Stream Only" (ะฒัะต ัะพะฑััะธั ัะพะปัะบะพ ะธะท Stream)

```
postOrder() โ ะะกะะะะ ะฒะพะทะฒัะฐัะฐะตะผ PENDING (ะธะณะฝะพัะธััะตะผ ัะตะฐะปัะฝัะน ััะฐััั)
ะคะธะฝะฐะปัะฝัะต ััะฐัััั (FILLED, REJECTED) โ ะขะะะฌะะ ะธะท TradesStream
```

**ะะปััั:**
- ะะดะธะฝะฐั ัะพัะบะฐ ะฟัะฑะปะธะบะฐัะธะธ ัะพะฑััะธะน
- ะัะพััะฐั ะปะพะณะธะบะฐ

**ะะธะฝััั:**
- ะะฐะดะตัะถะบะฐ ะดะปั ะบะปะธะตะฝัะฐ: ะฒะธะดะธั PENDING, ัะพัั MARKET ะพัะดะตั ัะถะต ะธัะฟะพะปะฝะตะฝ
- ะะปั MARKET ะพัะดะตัะพะฒ ััะพ ัััะฐะฝะฝะพ โ ะพะฝะธ ะธัะฟะพะปะฝััััั ะผะณะฝะพะฒะตะฝะฝะพ

#### ะะฐัะธะฐะฝั B: Idempotent ะพะฑัะฐะฑะพัะบะฐ (ั ะะ)

```
ะัะธ ะฟะพะปััะตะฝะธะธ ัะพะฑััะธั (ะธะท postOrder ะธะปะธ TradesStream):
  1. ะงะธัะฐะตะผ ัะตะบััะธะน ััะฐััั ะธะท order_mappings
  2. ะัะปะธ ัะตะบััะธะน ััะฐััั "ัะธะฝะฐะปัะฝัะน" (FILLED/REJECTED/CANCELLED):
     โ ะะณะฝะพัะธััะตะผ ัะพะฑััะธะต (ัะถะต ะพะฑัะฐะฑะพัะฐะฝะพ)
  3. ะัะปะธ PENDING โ ะฝะพะฒัะน ััะฐััั:
     โ ะะฑะฝะพะฒะปัะตะผ ะะ
     โ ะัะฑะปะธะบัะตะผ ัะพะฑััะธะต
```

**ะะปััั:**
- ะะพััะตะบัะฝัะต ััะฐัััั ััะฐะทั (MARKET โ FILLED ะฑะตะท ะทะฐะดะตัะถะบะธ)
- ะะฐะฑะพัะฐะตั ะฟะพัะปะต ัะตััะฐััะฐ
- ะะฐะดัะถะฝะพ

**ะะธะฝััั:**
- ะะพะฟะพะปะฝะธัะตะปัะฝะฐั ะะ-ะพะฟะตัะฐัะธั ะฝะฐ ะบะฐะถะดะพะต ัะพะฑััะธะต

#### ะะฐัะธะฐะฝั C: ะะธะฑัะธะดะฝัะน (ัะตะบะพะผะตะฝะดัะตะผัะน)

```
postOrder():
  1. ะกะพะทะดะฐัะผ ะทะฐะฟะธัั ะฒ order_mappings (status = PENDING)
  2. ะัะทัะฒะฐะตะผ Tinkoff API
  3. ะัะปะธ Tinkoff ะฒะตัะฝัะป FILL:
     โ ะะฑะฝะพะฒะปัะตะผ order_mappings (status = FILLED)
     โ ะะพะทะฒัะฐัะฐะตะผ FILLED
  4. ะัะปะธ Tinkoff ะฒะตัะฝัะป NEW/PENDING:
     โ ะััะฐะฒะปัะตะผ PENDING
     โ ะะพะทะฒัะฐัะฐะตะผ PENDING

StreamManager (TradesStream):
  1. ะะพะปััะฐะตะผ ัะพะฑััะธะต
  2. ะะฐัะพะดะธะผ ะพัะดะตั ะฒ order_mappings ะฟะพ tinkoff_order_id
  3. ะัะพะฒะตััะตะผ ัะตะบััะธะน ััะฐััั:
     โ ะัะปะธ ัะถะต FILLED โ ะธะณะฝะพัะธััะตะผ (ะดัะฑะปั)
     โ ะัะปะธ PENDING โ ะพะฑะฝะพะฒะปัะตะผ, ะฟัะฑะปะธะบัะตะผ
```

**ะะปััั:**
- ะัััััะน ะพัะฒะตั ะดะปั MARKET (ััะฐะทั FILLED)
- ะะฐัะธัะฐ ะพั ะดัะฑะปะตะน
- ะะฐะฑะพัะฐะตั ะฟะพัะปะต ัะตััะฐััะฐ

---

## TradesStream โ ะฟะพะดะฟะธัะบะฐ ะฝะฐ ะธัะฟะพะปะฝะตะฝะธั

### ะะพะณะดะฐ ะฟะพะดะฟะธััะฒะฐัััั?

**ะะพะฟัะพั:** ะ ะบะฐะบะพะน ะผะพะผะตะฝั ะทะฐะฟััะบะฐัั TradesStream?

**ะะฐัะธะฐะฝัั:**

| ะะฐัะธะฐะฝั | ะะพะณะดะฐ | ะะปััั | ะะธะฝััั |
|---------|-------|-------|--------|
| A | ะัะธ ััะฐััะต broker-service | ะกัะฐะทั ะณะพัะพะฒ | ะัะถะตะฝ ัะพัั ะฑั ะพะดะธะฝ ัะพะบะตะฝ |
| B | ะัะธ registerAccount() | ะะพะณะธัะฝะพ | ะัะปะธ ะฝะตั ะฐะบะบะฐัะฝัะพะฒ โ stream ะฝะต ะฝัะถะตะฝ |
| C | ะัะธ ะฟะตัะฒะพะผ placeOrder() | Lazy | ะะพะถะตั ะฟัะพะฟัััะธัั ัะพะฑััะธั |

**ะะตะบะพะผะตะฝะดะฐัะธั:** ะะฐัะธะฐะฝั B โ ะฟัะธ ัะตะณะธัััะฐัะธะธ ะฟะตัะฒะพะณะพ ะฐะบะบะฐัะฝัะฐ.

### ะะดะธะฝ stream ะธะปะธ ะฝะตัะบะพะปัะบะพ?

**ะคะฐะบั ะธะท ะดะพะบัะผะตะฝัะฐัะธะธ:**
> "ะ ะดะฐะฝะฝัะน ัััะธะผ ะฟะพะฟะฐะดะฐัั ะฒัะต ัะพะฒะตัััะฝะฝัะต ัะดะตะปะบะธ ะฟะพ ะฒัะตะผ ััะตัะฐะผ ะฟะพะปัะทะพะฒะฐัะตะปั"

ะญัะพ ะทะฝะฐัะธั: **ะพะดะธะฝ ัะพะบะตะฝ = ะพะดะธะฝ stream = ะฒัะต ะฐะบะบะฐัะฝัั ััะพะณะพ ัะพะบะตะฝะฐ**.

**ะะพ:** ะัะปะธ ั ะฝะฐั ัะฐะทะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ ั ัะฐะทะฝัะผะธ ัะพะบะตะฝะฐะผะธ Tinkoff:

```
User A โ Tinkoff Token A โ Stream A
User B โ Tinkoff Token B โ Stream B
User C โ Tinkoff Token A โ Stream A (ัะพั ะถะต stream!)
```

**ะััะธัะตะบัััะฐ StreamManager:**

```cpp
class StreamManager {
    // ะะดะธะฝ stream ะฝะฐ ัะฝะธะบะฐะปัะฝัะน ัะพะบะตะฝ
    std::unordered_map<std::string, std::unique_ptr<TradesStreamConnection>> streams_;
    
    // token_hash โ connection
    // (ัััะธััะตะผ ัะพะบะตะฝ ะดะปั ะฑะตะทะพะฟะฐัะฝะพััะธ ะฒ ะปะพะณะฐั)
    
    void ensureStreamForToken(const std::string& token) {
        auto hash = hashToken(token);
        if (streams_.find(hash) == streams_.end()) {
            auto conn = std::make_unique<TradesStreamConnection>(token);
            conn->setCallback([this](const OrderTrades& trades) {
                handleTradesEvent(trades);
            });
            conn->start();
            streams_[hash] = std::move(conn);
        }
    }
};
```

### Reconnect ะปะพะณะธะบะฐ

```
TradesStreamConnection:
  while (!stopped_) {
    try {
      connectAndListen();
    } catch (const std::exception& e) {
      log("Stream error: {}", e.what());
      sleep(exponentialBackoff());
      // Retry
    }
  }
  
exponentialBackoff():
  delay = min(baseDelay * 2^attempts, maxDelay)
  // 1s, 2s, 4s, 8s, 16s, 32s, 60s (max)
```

---

## ะกะธะฝััะพะฝะธะทะฐัะธั ะธ ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต

### ะัะพะฑะปะตะผะฐ: ัะตััะฐัั broker-service

ะะพัะปะต ัะตััะฐััะฐ:
- TradesStream ะพัะบะปัััะฝ
- ะ order_mappings ะตััั PENDING ะพัะดะตัะฐ
- ะะพะบะฐ ะผั ะฑัะปะธ offline โ ะพัะดะตัะฐ ะผะพะณะปะธ ะธัะฟะพะปะฝะธัััั

### ะะปะณะพัะธัะผ ัะธะฝััะพะฝะธะทะฐัะธะธ ะฟัะธ ััะฐััะต

```
1. ะะฐะณััะทะธัั ะฒัะต account_mappings (is_active = true)

2. ะะปั ะบะฐะถะดะพะณะพ ัะฝะธะบะฐะปัะฝะพะณะพ ัะพะบะตะฝะฐ:
   โ ะะฐะฟัััะธัั TradesStream

3. ะะฐะณััะทะธัั ะฒัะต order_mappings ัะพ ััะฐัััะพะผ PENDING

4. ะะปั ะบะฐะถะดะพะณะพ PENDING ะพัะดะตัะฐ:
   โ ะัะทะฒะฐัั GetOrderState(tinkoff_order_id)
   โ ะัะปะธ ััะฐััั ะธะทะผะตะฝะธะปัั:
      โ ะะฑะฝะพะฒะธัั order_mappings
      โ ะะฟัะฑะปะธะบะพะฒะฐัั ัะพะฑััะธะต (order.filled / order.cancelled / etc.)

5. ะะพัะพะฒะพ ะบ ะฟัะธัะผั ะฝะพะฒัั ะพัะดะตัะพะฒ
```

### GetOrderState ะดะปั ัะธะฝััะพะฝะธะทะฐัะธะธ

```cpp
void TinkoffBrokerAdapter::syncPendingOrders() {
    auto pendingOrders = orderTracker_->getPendingOrders();
    
    for (const auto& order : pendingOrders) {
        try {
            auto state = grpcClient_->getOrderState(
                order.tinkoffAccountId, 
                order.tinkoffOrderId
            );
            
            if (state.status != order.status) {
                orderTracker_->updateStatus(order.ourOrderId, state);
                publishStatusChange(order, state);
            }
        } catch (const std::exception& e) {
            // ะัะดะตั ะฝะต ะฝะฐะนะดะตะฝ? ะะพะทะผะพะถะฝะพ ัะถะต ะธัะฟะพะปะฝะตะฝ ะดะฐะฒะฝะพ
            // ะะพะผะตัะฐะตะผ ะบะฐะบ UNKNOWN ะดะปั ัััะฝะพะน ะฟัะพะฒะตัะบะธ
            log("Failed to sync order {}: {}", order.ourOrderId, e.what());
        }
    }
}
```

### ะะณัะฐะฝะธัะตะฝะธะต GetOrderState

> "ะะตัะพะด ะฟะพะปััะตะฝะธั ััะฐัััะฐ ัะพัะณะพะฒะพะณะพ ะฟะพัััะตะฝะธั ะฝะต ะฟัะตะดััะผะพััะตะฝ ะดะปั ะฟะพะปััะตะฝะธั ะณะปัะฑะพะบะพะน ะธััะพัะธะธ ะธ ะผะพะถะตั ะฝะต ะฒะพะทะฒัะฐัะฐัั ะธะฝัะพัะผะฐัะธั ะฟะพ ะฟะพัััะตะฝะธัะผ 'ััะฐััะต' ะพะดะฝะธั ัััะพะบ."

**ะัะฒะพะด:** ะกะธะฝััะพะฝะธะทะฐัะธั ัะฐะฑะพัะฐะตั ัะพะปัะบะพ ะดะปั "ัะฒะตะถะธั" ะพัะดะตัะพะฒ. ะกัะฐััะต PENDING ะฝัะถะฝะพ ะพะฑัะฐะฑะฐััะฒะฐัั ะพัะดะตะปัะฝะพ (ัััะฝะฐั ะฟัะพะฒะตัะบะฐ ะธะปะธ ะฟะพะผะตัะบะฐ ะบะฐะบ UNKNOWN).

---

## ะะตัะฐะบัะพัะธะฝะณ FakeBroker (ัะตั. ะดะพะปะณ)

### ะัะพะฑะปะตะผะฐ

OrderProcessor โ ะฑะพะถะตััะฒะตะฝะฝัะน ะบะปะฐัั (~400 ัััะพะบ) ั ะผะฝะพะถะตััะฒะพะผ if-else.

### ะะตัะตะฝะธะต: 4 ะฝะตะทะฐะฒะธัะธะผัั ะฟัะพัะตััะพัะฐ

```
OrderProcessor (ะฑัะปะพ)        โ    4 ะฟัะพัะตััะพัะฐ (ะฑัะดะตั)
       โ                              โ
       โผ                              โผ
โโโโโโโโโโโโโโโโโโโ           โโโโโโโโโโโโโโโโโโโ
โ processOrder()  โ           โ MarketBuyProc   โ
โ   if MARKET...  โ           โโโโโโโโโโโโโโโโโโโค
โ   if LIMIT...   โ           โ MarketSellProc  โ
โ   if BUY...     โ           โโโโโโโโโโโโโโโโโโโค
โ   if SELL...    โ           โ LimitBuyProc    โ
โโโโโโโโโโโโโโโโโโโ           โโโโโโโโโโโโโโโโโโโค
                              โ LimitSellProc   โ
                              โโโโโโโโโโโโโโโโโโโ
```

### ะัะตะธะผััะตััะฒะฐ

| ะัะฟะตะบั | 1 ะบะปะฐัั | 4 ะบะปะฐััะฐ |
|--------|---------|----------|
| ะกััะพะบ | ~400 | ~80-100 ะบะฐะถะดัะน |
| ะขะตััะธัะพะฒะฐะฝะธะต | ะกะปะพะถะฝะพ | ะะทะพะปะธัะพะฒะฐะฝะฝะพ |
| ะะทะผะตะฝะตะฝะธั | ะะธัะบ ัะปะพะผะฐัั ะฒัั | ะะตะทะฐะฒะธัะธะผะพ |

### ะัะฑะปะธัะพะฒะฐะฝะธะต โ ัะพะทะฝะฐัะตะปัะฝัะน ะฒัะฑะพั

ะะฐ, ะฑัะดะตั ะดัะฑะปะธัะพะฒะฐะฝะธะต ะบะพะดะฐ ะผะตะถะดั ะฟัะพัะตััะพัะฐะผะธ. ะะพ:
- ะะฐะถะดัะน ะฟัะพัะตััะพั ะฝะตะทะฐะฒะธัะธะผ
- ะะพะถะฝะพ ะผะตะฝััั ะปะพะณะธะบั ะพะดะฝะพะณะพ ะฑะตะท ะฒะปะธัะฝะธั ะฝะฐ ะดััะณะธะต
- ะัะพัะต ะฟะพะฝััั ะธ ะพัะปะฐะดะธัั

### ะกัะฐััั

**ะัะธะพัะธัะตั:** ะะธะทะบะธะน (ัะตั. ะดะพะปะณ)  
**ะะพะณะดะฐ ะดะตะปะฐัั:** ะะพัะปะต ะธะฝัะตะณัะฐัะธะธ ั Tinkoff  
**ะัะตะฝะบะฐ:** 4-6 ัะฐัะพะฒ

---

## ะัะบััััะต ะฒะพะฟัะพัั

### 1. ะัะบัะดะฐ ะฑะตััััั tinkoff_account_id?

**ะะฐัะธะฐะฝัั:**

A) ะะพะปัะทะพะฒะฐัะตะปั ะฒะฒะพะดะธั ะฒัััะฝัั ะฟัะธ ัะตะณะธัััะฐัะธะธ
   - ะะปัั: ะฟัะพััะพ
   - ะะธะฝัั: ะฟะพะปัะทะพะฒะฐัะตะปั ะดะพะปะถะตะฝ ะทะฝะฐัั ID

B) ะั ะฒัะทัะฒะฐะตะผ GetAccounts() ะฟะพ ัะพะบะตะฝั ะธ ะฟะพะบะฐะทัะฒะฐะตะผ ัะฟะธัะพะบ
   - ะะปัั: ัะดะพะฑะฝะพ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั
   - ะะธะฝัั: ะดะพะฟะพะปะฝะธัะตะปัะฝัะน UI

C) ะะฒัะพะผะฐัะธัะตัะบะธ ะฑะตััะผ ะฟะตัะฒัะน ะฐะบะบะฐัะฝั ะธะท GetAccounts()
   - ะะปัั: zero-config
   - ะะธะฝัั: ั ะฟะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ะฑััั ะฝะตัะบะพะปัะบะพ ะฐะบะบะฐัะฝัะพะฒ

**ะะพะฟัะพั ะดะปั ะพะฑััะถะดะตะฝะธั:** ะะฐะบะพะน ะฒะฐัะธะฐะฝั ะฒัะฑัะฐัั?

### 2. ะะฐะบ ััะฐะฝะธัั ัะพะบะตะฝ Tinkoff?

**ะะฐัะธะฐะฝัั:**

A) ะ ะะ ะทะฐัะธััะพะฒะฐะฝะฝัะผ (AES-256)
   - ะะปัั: ะฟัะพััะพัะฐ
   - ะะธะฝัั: ะบะปัั ัะธััะพะฒะฐะฝะธั ะฝัะถะฝะพ ะณะดะต-ัะพ ััะฐะฝะธัั

B) ะ ัะตะบัะตัะฐั K8s (Kubernetes Secrets)
   - ะะปัั: ััะฐะฝะดะฐััะฝัะน ะฟะพะดัะพะด ะดะปั K8s
   - ะะธะฝัั: ะฟัะธะฒัะทะบะฐ ะบ K8s

C) ะะฝะตัะฝะธะน Vault (HashiCorp Vault, AWS Secrets Manager)
   - ะะปัั: enterprise-grade
   - ะะธะฝัั: ะดะพะฟะพะปะฝะธัะตะปัะฝะฐั ะธะฝััะฐััััะบัััะฐ

**ะะพะฟัะพั ะดะปั ะพะฑััะถะดะตะฝะธั:** ะะฐะบะพะน ััะพะฒะตะฝั ะฑะตะทะพะฟะฐัะฝะพััะธ ะฝัะถะตะฝ?

### 3. ะงัะพ ะดะตะปะฐัั ะตัะปะธ Tinkoff ะฝะตะดะพัััะฟะตะฝ?

**ะกัะตะฝะฐัะธะธ:**
- gRPC timeout
- RESOURCE_EXHAUSTED (ะปะธะผะธัั)
- UNAVAILABLE (ัะตัะฒะธั ะฝะตะดะพัััะฟะตะฝ)

**ะะฐัะธะฐะฝัั:**

A) Reject ััะฐะทั
   - ะะปัั: ะฟัะพััะพัะฐ
   - ะะธะฝัั: ะฟะปะพัะพะน UX

B) Retry ั exponential backoff
   - ะะปัั: ัััะพะนัะธะฒะพััั ะบ ะฒัะตะผะตะฝะฝัะผ ัะฑะพัะผ
   - ะะธะฝัั: ะทะฐะดะตัะถะบะฐ

C) Circuit Breaker
   - ะะปัั: ะทะฐัะธัะฐ ะพั ะบะฐัะบะฐะดะฝัั ัะฑะพะตะฒ
   - ะะธะฝัั: ัะปะพะถะฝะพััั ัะตะฐะปะธะทะฐัะธะธ

D) ะัะตัะตะดั ะพัะปะพะถะตะฝะฝัั ะพัะดะตัะพะฒ
   - ะะปัั: ะฝะต ัะตััะตะผ ะพัะดะตัะฐ
   - ะะธะฝัั: ัะปะพะถะฝะพััั, ะฒะพะทะผะพะถะฝั ะฟัะพะฑะปะตะผั ั ะฐะบััะฐะปัะฝะพัััั ัะตะฝ

**ะะพะฟัะพั ะดะปั ะพะฑััะถะดะตะฝะธั:** ะะฐะบัั ัััะฐัะตะณะธั ะฒัะฑัะฐัั?

### 4. Sandbox vs Production

**ะคะฐะบัั:**
- ะะฐะทะฝัะต endpoints
- Sandbox ะฝะต ััะตะฑัะตั ัะตะฐะปัะฝัั ะดะตะฝะตะณ
- Sandbox "ะทะฝะฐะตั" ะพ ัะตะบััะธั ััะฝะพัะฝัั ะบะพัะธัะพะฒะบะฐั

**ะะพะฟัะพัั:**
- ะะฐะบ ะฟะตัะตะบะปััะฐัััั ะผะตะถะดั ะบะพะฝัััะฐะผะธ?
- ะะดะธะฝ ะบะพะฝัะธะณ ะธะปะธ ะดะฒะฐ ัะฐะทะฝัั deployment?
- ะะพะถะฝะพ ะปะธ ะธัะฟะพะปัะทะพะฒะฐัั ะพะฑะฐ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ ะดะปั ัะฐะทะฝัั ะฐะบะบะฐัะฝัะพะฒ?

### 5. ะงัะพ ะตัะปะธ TradesStream ะพัะฒะฐะปะธะปัั ะธ ะดะพะปะณะพ ะฝะต ัะฐะฑะพัะฐะป?

**ะกัะตะฝะฐัะธะน:**
- Stream ะพัะบะปััะธะปัั ะฒ 10:00
- ะะตัะตะฟะพะดะบะปััะธะปะธัั ะฒ 10:30
- ะะฐ ััะพ ะฒัะตะผั 5 ะพัะดะตัะพะฒ ะธัะฟะพะปะฝะธะปะธัั

**ะะพะฟัะพัั:**
- ะะฐะบ ัะทะฝะฐัั ะพะฑ ััะธั ะพัะดะตัะฐั?
- GetOrders() ะฒะพะทะฒัะฐัะฐะตั ัะพะปัะบะพ ะฐะบัะธะฒะฝัะต
- GetOrderState() โ ัะพะปัะบะพ ะดะปั "ัะฒะตะถะธั" ะพัะดะตัะพะฒ

**ะะพะทะผะพะถะฝะพะต ัะตัะตะฝะธะต:**
- ะัะธ reconnect ะฒัะทัะฒะฐัั GetOperationsByCursor() ะทะฐ ะฟะตัะธะพะด offline
- ะะปะธ ััะธัะฐัั ััะพ edge case ะธ ะพะฑัะฐะฑะฐััะฒะฐัั ะฒัััะฝัั

### 6. Rate limiting ะฝะฐ ะฝะฐัะตะน ััะพัะพะฝะต

**ะัะพะฑะปะตะผะฐ:** ะัะปะธ ะผะฝะพะณะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะพัะฟัะฐะฒะปััั ะพัะดะตัะฐ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ โ ะผะพะถะตะผ ะฟัะตะฒััะธัั ะปะธะผะธัั Tinkoff.

**ะะพะฟัะพัั:**
- ะัะถะตะฝ ะปะธ ัะฒะพะน rate limiter?
- ะะฑัะธะน ะฝะฐ ะฒะตัั broker-service ะธะปะธ per-token?
- ะะฐะบ ะฟัะธะพัะธัะธะทะธัะพะฒะฐัั ะทะฐะฟัะพัั?

### 7. ะะฐะฟะฟะธะฝะณ ะพัะธะฑะพะบ

**ะะพะฟัะพั:** ะะฐะบ ะผะฐะฟะธัั ะพัะธะฑะบะธ Tinkoff ะฝะฐ ะฝะฐัะธ?

| Tinkoff Error | ะะฐั ััะฐััั | ะกะพะพะฑัะตะฝะธะต |
|---------------|------------|-----------|
| 30059 | REJECTED | Cannot cancel order |
| 80001 | REJECTED | Rate limit exceeded |
| ??? | ??? | ??? |

**ะัะถะฝะพ:** ะกะพััะฐะฒะธัั ะฟะพะปะฝัั ัะฐะฑะปะธัั ะผะฐะฟะฟะธะฝะณะฐ ะพัะธะฑะพะบ.

---

## ะะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ

### ะคะฐะทะฐ 1: ะะพะดะณะพัะพะฒะบะฐ (2-3 ะดะฝั)

- [ ] ะะทััะธัั proto-ะบะพะฝััะฐะบัั Tinkoff API
- [ ] ะะฐัััะพะธัั gRPC ะบะปะธะตะฝั (grpc++ ะธะปะธ ะณะพัะพะฒะฐั ะฑะธะฑะปะธะพัะตะบะฐ)
- [ ] ะกะพะทะดะฐัั ัะฐะฑะปะธัั account_mappings, order_mappings
- [ ] ะะฐะฟะธัะฐัั ะผะธะณัะฐัะธะธ

### ะคะฐะทะฐ 2: ะะฐะทะพะฒะฐั ะธะฝัะตะณัะฐัะธั (3-4 ะดะฝั)

- [ ] TinkoffGrpcClient: postOrder, cancelOrder, getOrderState
- [ ] AccountRegistry: registerAccount, unregisterAccount
- [ ] OrderTracker: create, updateStatus, findByTinkoffId
- [ ] TinkoffBrokerAdapter: ัะตะฐะปะธะทะฐัะธั IBrokerGateway

### ะคะฐะทะฐ 3: TradesStream (2-3 ะดะฝั)

- [ ] TradesStreamConnection: ะฟะพะดะบะปััะตะฝะธะต, reconnect
- [ ] StreamManager: ัะฟัะฐะฒะปะตะฝะธะต ัะพะตะดะธะฝะตะฝะธัะผะธ
- [ ] ะะฑัะฐะฑะพัะบะฐ ัะพะฑััะธะน, idempotent ะปะพะณะธะบะฐ
- [ ] ะะฝัะตะณัะฐัะธั ั EventPublisher

### ะคะฐะทะฐ 4: ะกะธะฝััะพะฝะธะทะฐัะธั (1-2 ะดะฝั)

- [ ] ะกะธะฝััะพะฝะธะทะฐัะธั PENDING ะพัะดะตัะพะฒ ะฟัะธ ััะฐััะต
- [ ] ะะฑัะฐะฑะพัะบะฐ edge cases (ััะฐััะต ะพัะดะตัะฐ, ะฝะตะดะพัััะฟะฝะพััั API)

### ะคะฐะทะฐ 5: ะขะตััะธัะพะฒะฐะฝะธะต (2-3 ะดะฝั)

- [ ] Unit-ัะตััั ั ะผะพะบะฐะผะธ
- [ ] ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั ั Sandbox
- [ ] ะขะตััั reconnect, rate limiting, error handling

### ะะฑัะฐั ะพัะตะฝะบะฐ: 10-15 ัะฐะฑะพัะธั ะดะฝะตะน (20-30 ัะฐัะพะฒ)

---

## ะกััะปะบะธ

- [Tinkoff Invest API Documentation](https://tinkoff.github.io/investAPI/)
- [GitHub: investAPI](https://github.com/Tinkoff/investAPI)
- [GitHub: C++ SDK](https://github.com/samoilovv/TinkoffInvestSDK)
- [ะะธะผะธัะฝะฐั ะฟะพะปะธัะธะบะฐ](https://tinkoff.github.io/investAPI/limits/)
- [ะกะตัะฒะธั ะพัะดะตัะพะฒ](https://tinkoff.github.io/investAPI/head-orders/)
- [TradesStream](https://tinkoff.github.io/investAPI/orders/#tradesstream)

---

*ะะพะบัะผะตะฝั ัะพะทะดะฐะฝ: 2025-01-07*  
*ะะพัะปะตะดะฝะตะต ะพะฑะฝะพะฒะปะตะฝะธะต: 2025-01-07*
