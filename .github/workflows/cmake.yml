name: CMake CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîÑ Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: üõ† Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ gcovr libboost-all-dev
      
    - name: üèó Configure with coverage
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=ON \
          -DCMAKE_CXX_FLAGS="--coverage -g -O0 -fprofile-arcs -ftest-coverage"
      
    - name: ‚öôÔ∏è Build
      run: cmake --build build -j$(nproc)
      
    - name: üìã Find test executables
      run: |
        echo "=== Build directory structure ==="
        find build -name "mvp_tests" -type f 2>/dev/null || echo "mvp_tests not found by name"
        echo ""
        echo "=== Looking for test executables ==="
        find build -name "*tests" -type f -executable 2>/dev/null | head -20
        echo ""
        echo "=== MVP subdirectory ==="
        ls -la build/mvp/ 2>/dev/null || echo "build/mvp/ not found"

    - name: üß™ List available tests
      run: |
        # –ò—â–µ–º mvp_tests –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
        if [ -f build/mvp/mvp_tests ]; then
          TEST_EXECUTABLE=build/mvp/mvp_tests
        elif [ -f build/mvp_tests ]; then
          TEST_EXECUTABLE=build/mvp_tests
        else
          echo "ERROR: Cannot find mvp_tests executable!"
          find build -name "*test*" -type f -executable 2>/dev/null
          exit 1
        fi
        
        echo "Found test executable: $TEST_EXECUTABLE"
        echo "=== Available tests ==="
        ./$TEST_EXECUTABLE --gtest_list_tests || true
      
    - name: ‚úÖ Run MVP tests
      run: |
        # –ò—â–µ–º mvp_tests –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
        if [ -f build/mvp/mvp_tests ]; then
          TEST_EXECUTABLE=build/mvp/mvp_tests
        elif [ -f build/mvp_tests ]; then
          TEST_EXECUTABLE=build/mvp_tests
        else
          echo "ERROR: Cannot find mvp_tests executable!"
          exit 1
        fi
        
        echo "Running: $TEST_EXECUTABLE"
        ./$TEST_EXECUTABLE --gtest_output=xml:build/test_results.xml
      
    - name: üìä Generate HTML coverage report
      if: always()
      run: |
        gcovr \
          --root . \
          --exclude '.*CMakeFiles/.*' \
          --exclude '.*CompilerIdCXX.*' \
          --exclude '.*CompilerIdC.*' \
          --exclude '.*cmake/.*' \
          --exclude '.*tests/.*' \
          --exclude '.*_deps/.*' \
          --exclude '.*demo/.*' \
          --exclude '.*benchmarks/.*' \
          --gcov-ignore-parse-errors=all \
          --html-details coverage.html \
          --print-summary || true
              
    - name: üì§ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: build/test_results.xml

    - name: üì§ Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-html
        path: coverage*.html

  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: üîÑ Checkout
      uses: actions/checkout@v4 

    - name: üîç Debug file structure
      run: |
        echo "=== Current directory structure ==="
        pwd
        ls -la
        echo ""
        echo "=== Looking for Dockerfile ==="
        find . -name "Dockerfile" -type f 2>/dev/null | head -20

    - name: üê≥ Build Docker image
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è Dockerfile –∏ –º–µ–Ω—è–µ–º –≤ –Ω–µ–≥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        if [ -f "Dockerfile" ]; then
          echo "Building from root Dockerfile"
          docker build -t trading-mvp:test .
        elif [ -f "mvp/Dockerfile" ]; then
          echo "Building from mvp/Dockerfile"
          cd mvp
          docker build -t trading-mvp:test .
        elif [ -f "docker/Dockerfile" ]; then
          echo "Building from docker/Dockerfile"
          cd docker
          docker build -t trading-mvp:test .
        else
          echo "ERROR: Dockerfile not found!"
          echo "Current directory contents:"
          ls -la
          echo "Searching for Dockerfile..."
          find . -name "Dockerfile" -type f 2>/dev/null
          exit 1
        fi
      
    - name: üè• Test health endpoint
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–ª—Å—è
        if ! docker images trading-mvp:test -q | grep -q .; then
          echo "Docker image not built, skipping health check"
          exit 0
        fi
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        docker run -d --name trading-test -p 8080:8080 trading-mvp:test
        
        # –ñ–¥—ë–º —Å—Ç–∞—Ä—Ç–∞
        sleep 10
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º health
        curl -f http://localhost:8080/api/v1/health || exit 1
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
        docker stop trading-test
        docker rm trading-test
