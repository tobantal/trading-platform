name: CMake CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v3
      
    - name: ğŸ›  Install dependencies
      run: sudo apt-get update && sudo apt-get install -y cmake g++ gcovr
      
    - name: ğŸ— Configure with coverage
      run: cmake -B build -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage -g -O0"
      
    - name: âš™ï¸ Build
      run: cmake --build build
      
    - name: âœ… Run tests
      run: ctest --test-dir build --output-on-failure --verbose
      
    - name: ğŸ“Š Generate HTML coverage report
      run: |
        gcovr \
          --root . \
          --exclude '.*CMakeFiles/.*' \
          --exclude '.*CompilerIdCXX.*' \
          --exclude '.*CompilerIdC.*' \
          --exclude '.*cmake/.*' \
          --exclude '.*/tests/.*' \
          --exclude '.*_deps/.*' \
          --exclude '.*/demo/.*' \
          --gcov-ignore-parse-errors=all \
          --html-details coverage.html \
          --print-summary
              
    - name: ğŸ“¤ Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-html
        path: coverage*.html