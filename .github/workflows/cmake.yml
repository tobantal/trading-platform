name: CMake CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: üîÑ Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: üõ† Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++ gcovr libboost-all-dev
      
    - name: üèó Configure with coverage
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=ON \
          -DCMAKE_CXX_FLAGS="--coverage -g -O0 -fprofile-arcs -ftest-coverage"
      
    - name: ‚öôÔ∏è Build
      run: cmake --build build -j$(nproc)
      
    - name: üìã List test executable
      run: |
        echo "=== Build directory contents ==="
        ls -la build/
        echo ""
        echo "=== Looking for test executables ==="
        find build -name "*test*" -type f -executable 2>/dev/null || echo "No test executables found"
        echo ""
        echo "=== Looking for mvp_tests ==="
        ls -la build/mvp_tests 2>/dev/null || echo "mvp_tests not found"

    - name: üß™ List available tests
      run: |
        if [ -f build/mvp_tests ]; then
          echo "=== Available tests ==="
          ./build/mvp_tests --gtest_list_tests || true
        else
          echo "Test executable not found!"
          exit 1
        fi
      
    - name: ‚úÖ Run tests
      run: |
        cd build
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
        ./mvp_tests --gtest_output=xml:test_results.xml
      
    - name: üìä Generate HTML coverage report
      if: always()
      run: |
        gcovr \
          --root . \
          --exclude '.*CMakeFiles/.*' \
          --exclude '.*CompilerIdCXX.*' \
          --exclude '.*CompilerIdC.*' \
          --exclude '.*cmake/.*' \
          --exclude '.*tests/.*' \
          --exclude '.*_deps/.*' \
          --exclude '.*demo/.*' \
          --exclude '.*benchmarks/.*' \
          --gcov-ignore-parse-errors=all \
          --html-details coverage.html \
          --print-summary || true
              
    - name: üì§ Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: build/test_results.xml

    - name: üì§ Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report-html
        path: coverage*.html

  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: üîÑ Checkout
      uses: actions/checkout@v4
      
    - name: üê≥ Build Docker image
      run: docker build -t trading-mvp:test .
      
    - name: üè• Test health endpoint
      run: |
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        docker run -d --name trading-test -p 8080:8080 trading-mvp:test
        
        # –ñ–¥—ë–º —Å—Ç–∞—Ä—Ç–∞
        sleep 10
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º health
        curl -f http://localhost:8080/api/v1/health || exit 1
        
        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
        docker stop trading-test
        docker rm trading-test
